/**
 * ë…¸ì…˜ ë¸”ë¡ ë Œë”ë§ ë¡œì§ - ìƒˆë¡œ êµ¬í˜„ëœ ë²„ì „
 * 
 * ë‹¨ìˆœí•˜ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ìš´ êµ¬ì¡°ë¡œ êµ¬í˜„
 * - ë¸”ë¡ íƒ€ì…ë³„ ë Œë”ë§ í•¨ìˆ˜ ë¶„ë¦¬
 * - ì¬ê·€ í˜¸ì¶œ êµ¬ì¡° ë‹¨ìˆœí™”
 * - ëª…í™•í•œ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ë¡œê¹…
 * - ë“¤ì—¬ì“°ê¸° ê´€ë ¨ ë¬¸ì œ í•´ê²°
 */

import {
  BlockObjectResponse,
  PartialBlockObjectResponse,
  RichTextItemResponse
} from '@notionhq/client/build/src/api-endpoints';
import { notion } from './client';

// HTML ë¸”ë¡ì„ ìœ„í•œ í™•ì¥ íƒ€ì… ì •ì˜
interface HtmlBlockObjectResponse {
  id: string;
  type: 'html';
  html: {
    rich_text: RichTextItemResponse[];
  };
  created_time: string;
  last_edited_time: string;
  has_children: boolean;
  archived: boolean;
}

// í™•ì¥ëœ ë¸”ë¡ íƒ€ì…
type ExtendedBlockObjectResponse = BlockObjectResponse | HtmlBlockObjectResponse;

/**
 * íŠ¹ì • ë¸”ë¡ì˜ í•˜ìœ„ ë¸”ë¡ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
 */
export async function getBlocks(blockId: string): Promise<BlockObjectResponse[]> {
  try {
    console.log(`ğŸ” ë¸”ë¡ ${blockId}ì˜ í•˜ìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œì‘`);
    
    const blocks: BlockObjectResponse[] = [];
    let startCursor: string | undefined = undefined;
    let hasMore = true;
    
    // í˜ì´ì§€ë„¤ì´ì…˜ì„ ì²˜ë¦¬í•˜ë©´ì„œ ëª¨ë“  í•˜ìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°
    while (hasMore) {
      const response = await notion.blocks.children.list({
        block_id: blockId,
        start_cursor: startCursor,
        page_size: 100,
      });
      
      // ìœ íš¨í•œ ë¸”ë¡ë§Œ í•„í„°ë§
      const validBlocks = response.results.filter(
        (block): block is BlockObjectResponse => 'type' in block
      );
      
      blocks.push(...validBlocks);
      
      hasMore = response.has_more;
      startCursor = response.next_cursor ?? undefined;
    }
    
    console.log(`âœ… ë¸”ë¡ ${blockId}ì˜ í•˜ìœ„ ë¸”ë¡ ${blocks.length}ê°œ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`);
    return blocks;
  } catch (error) {
    console.error(`âŒ ë¸”ë¡ ${blockId} í•˜ìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:`, error);
    return [];
  }
}

/**
 * í˜ì´ì§€ì˜ ëª¨ë“  ë¸”ë¡ì„ ì¬ê·€ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
 */
export async function getPageBlocks(pageId: string, maxDepth = 3): Promise<BlockObjectResponse[]> {
  console.log(`ğŸ“„ í˜ì´ì§€ ${pageId}ì˜ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œì‘ (ìµœëŒ€ ê¹Šì´: ${maxDepth})`);
  
  try {
    // ìµœìƒìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°
    const blocks = await getBlocks(pageId);
    
    // ê° ë¸”ë¡ì— ëŒ€í•´ ì¬ê·€ì ìœ¼ë¡œ í•˜ìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°
    const populatedBlocks = await populateChildBlocks(blocks, 1, maxDepth);
    
    console.log(`ğŸ“„ í˜ì´ì§€ ${pageId}ì˜ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ì´ ${countBlocks(populatedBlocks)}ê°œ`);
    return populatedBlocks;
  } catch (error) {
    console.error(`âŒ í˜ì´ì§€ ${pageId}ì˜ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:`, error);
    return [];
  }
}

/**
 * ë¸”ë¡ì˜ í•˜ìœ„ ë¸”ë¡ì„ ì¬ê·€ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
 */
async function populateChildBlocks(
  blocks: BlockObjectResponse[],
  currentDepth: number,
  maxDepth: number
): Promise<BlockObjectResponse[]> {
  if (currentDepth > maxDepth) {
    return blocks;
  }
  
  const result: BlockObjectResponse[] = [];
  
  for (const block of blocks) {
    // ë¸”ë¡ì— children ì†ì„± ì¶”ê°€
    const blockWithChildren = block as BlockObjectResponse & { children?: BlockObjectResponse[] };
    
    // í•˜ìœ„ ë¸”ë¡ì´ ìˆëŠ” ê²½ìš° ê°€ì ¸ì˜¤ê¸°
    if (block.has_children) {
      try {
        const childBlocks = await getBlocks(block.id);
        const populatedChildBlocks = await populateChildBlocks(
          childBlocks,
          currentDepth + 1,
          maxDepth
        );
        
        blockWithChildren.children = populatedChildBlocks;
      } catch (error) {
        console.error(`âŒ ë¸”ë¡ ${block.id} í•˜ìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:`, error);
        blockWithChildren.children = [];
      }
    } else {
      blockWithChildren.children = [];
    }
    
    result.push(blockWithChildren);
  }
  
  return result;
}

/**
 * ë¸”ë¡ íŠ¸ë¦¬ì˜ ì´ ë¸”ë¡ ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
 */
function countBlocks(blocks: (BlockObjectResponse & { children?: BlockObjectResponse[] })[]): number {
  return blocks.reduce((count, block) => {
    const childCount = block.children?.length 
      ? countBlocks(block.children as (BlockObjectResponse & { children?: BlockObjectResponse[] })[])
      : 0;
    return count + 1 + childCount;
  }, 0);
}

/**
 * ì²« ë²ˆì§¸ ì´ë¯¸ì§€ URLì„ ì°¾ëŠ” í•¨ìˆ˜
 */
export function findFirstImage(blocks: (BlockObjectResponse & { children?: BlockObjectResponse[] })[]): string {
  for (const block of blocks) {
    if (block.type === 'image') {
      const image = (block as any).image;
      if (image?.file?.url) {
        return image.file.url;
      } else if (image?.external?.url) {
        return image.external.url;
      }
    }
    
    // í•˜ìœ„ ë¸”ë¡ ê²€ìƒ‰
    if (block.children?.length) {
      const imageUrl = findFirstImage(block.children as (BlockObjectResponse & { children?: BlockObjectResponse[] })[]);
      if (imageUrl) {
        return imageUrl;
      }
    }
  }
  
  return '';
}

/**
 * í˜ì´ì§€ ì»¨í…ì¸  ë° ì¸ë„¤ì¼ ê°€ì ¸ì˜¤ê¸°
 */
export async function getPageContentAndThumbnail(pageId: string): Promise<{ content: string, thumbnail: string, image: string }> {
  console.log(`ğŸ” í˜ì´ì§€ ${pageId}ì˜ ì»¨í…ì¸  ë° ì¸ë„¤ì¼ ê°€ì ¸ì˜¤ê¸° ì‹œì‘`);
  const startTime = Date.now();
  
  try {
    // ëª¨ë“  ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°
    const blocks = await getPageBlocks(pageId);
    
    if (!blocks || blocks.length === 0) {
      console.warn(`âš ï¸ í˜ì´ì§€ ${pageId}ì—ì„œ ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      return { content: '<p>ì»¨í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>', thumbnail: '', image: '' };
    }
    
    // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì°¾ê¸°
    let image = findFirstImage(blocks as (BlockObjectResponse & { children?: BlockObjectResponse[] })[]);
    let thumbnail = image;
    
    // ì»¤ë²„ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
    try {
      const page = await notion.pages.retrieve({ page_id: pageId });
      if (page && 'cover' in page && page.cover) {
        if ('external' in page.cover && page.cover.external?.url) {
          thumbnail = page.cover.external.url;
        } else if ('file' in page.cover && page.cover.file?.url) {
          thumbnail = page.cover.file.url;
        }
        console.log(`ğŸ–¼ï¸ í˜ì´ì§€ ì»¤ë²„ ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©: ${thumbnail.substring(0, 50)}...`);
      } else {
        console.log(`ğŸ–¼ï¸ í˜ì´ì§€ ì»¤ë²„ ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ. ë³¸ë¬¸ ì²« ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©.`);
      }
    } catch (error) {
      console.error(`âŒ í˜ì´ì§€ ${pageId} ì»¤ë²„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:`, error);
    }
    
    // ë¸”ë¡ì„ HTMLë¡œ ë³€í™˜
    console.log(`ğŸ”„ ë¸”ë¡ì„ HTMLë¡œ ë³€í™˜ ì‹œì‘: ${blocks.length}ê°œ ìµœìƒìœ„ ë¸”ë¡`);
    let content = renderBlocksToHtmlWithListHandling(blocks as (BlockObjectResponse & { children?: BlockObjectResponse[] })[]);

    // ìµœì¢… ê°€ê³µ: ëª¨ë“  ë…ë¦½ì ì¸ figure íƒœê·¸ ì œê±°
    // 1. ë‹«ëŠ” íƒœê·¸ê°€ ë…ë¦½ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” ê²½ìš° (ë‹«ëŠ” íƒœê·¸ë§Œ ìˆê³  ì—¬ëŠ” íƒœê·¸ ì—†ìŒ)
    content = removeOrphanedClosingTags(content, 'figure');

    // 2. ë¶ˆí•„ìš”í•œ figure íƒœê·¸ í…ìŠ¤íŠ¸ ì œê±° (ì´ìŠ¤ì¼€ì´í”„ëœ í…ìŠ¤íŠ¸ í˜•íƒœ)
    content = content.replace(/&lt;\/figure&gt;/g, '');
    content = content.replace(/&lt;figure&gt;/g, '');
    content = content.replace(/<\/figure>/g, ''); // í…ìŠ¤íŠ¸ë¡œ ì¡´ì¬í•˜ëŠ” ë‹«ëŠ” íƒœê·¸ ì œê±°
    content = content.replace(/([^<]|^)\/figure>/g, '$1'); // '/'ë¡œ ì‹œì‘í•˜ëŠ” ë³€í˜•ëœ í˜•íƒœ ì œê±°

    // 3. ì¶”ê°€ ì²˜ë¦¬: í…ìŠ¤íŠ¸ë¡œ ëœ HTML íƒœê·¸ë¥¼ ì‹¤ì œ HTMLë¡œ ë³€í™˜
    // HTML ë¬¸ë²•ì´ ì¶”ì •ë˜ëŠ” íŒ¨í„´ ê°ì§€ ë° ì²˜ë¦¬
    if (content.includes('&lt;figure') || content.includes('&lt;img')) {
      console.log('ğŸ“Œ HTML íƒœê·¸ê°€ í…ìŠ¤íŠ¸ë¡œ ê°ì§€ë¨, ì‹¤ì œ HTMLë¡œ ë³€í™˜ ì‹œë„');
      
      // HTML ì—”í‹°í‹° ë””ì½”ë”©
      content = content
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&amp;/g, '&')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'");
        
      console.log('âœ… HTML ì—”í‹°í‹° ë””ì½”ë”© ì™„ë£Œ');
    }

    const endTime = Date.now();
    const totalTime = (endTime - startTime) / 1000;
    
    console.log(`â±ï¸ ì´ ì†Œìš” ì‹œê°„: ${totalTime.toFixed(2)}ì´ˆ`);
    console.log(`ğŸ“Š ìƒì„±ëœ HTML ê¸¸ì´: ${content.length} ê¸€ì`);
    
    return { content, thumbnail, image };
  } catch (error) {
    console.error(`âŒ í˜ì´ì§€ ${pageId} ì»¨í…ì¸  ë³€í™˜ ì˜¤ë¥˜:`, error);
    return {
      content: `<p class="text-red-500">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>`,
      thumbnail: '',
      image: ''
    };
  }
}

/**
 * ë¸”ë¡ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
 */
export function renderBlocksToHtml(blocks: (BlockObjectResponse & { children?: BlockObjectResponse[] })[]): string {
  const html = blocks.map(block => renderBlock(block as ExtendedBlockObjectResponse & { children?: ExtendedBlockObjectResponse[] })).join('');
  return html;
}

/**
 * Rich Text ë°°ì—´ì„ HTML ë¬¸ìì—´ë¡œ ë Œë”ë§
 */
function renderRichText(richTextItems: any[] = []): string {
  if (!richTextItems || richTextItems.length === 0) {
    return '';
  }
  
  return richTextItems.map(text => {
    if (!text) return '';
    
    // í…ìŠ¤íŠ¸ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸° (plain_text ë˜ëŠ” text.content)
    const content = text.plain_text || (text.text && text.text.content) || '';
    if (!content) return '';
    
    // HTML íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
    let formattedText = content
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
    
    // ìŠ¤íƒ€ì¼ ì ìš©
    if (text.annotations) {
      if (text.annotations.bold) {
        formattedText = `<strong>${formattedText}</strong>`;
      }
      if (text.annotations.italic) {
        formattedText = `<em>${formattedText}</em>`;
      }
      if (text.annotations.strikethrough) {
        formattedText = `<del>${formattedText}</del>`;
      }
      if (text.annotations.underline) {
        formattedText = `<u>${formattedText}</u>`;
      }
      if (text.annotations.code) {
        formattedText = `<code>${formattedText}</code>`;
      }
    }
    
    // ë§í¬ ì²˜ë¦¬
    if (text.href) {
      formattedText = `<a href="${text.href}" target="_blank" rel="noopener noreferrer">${formattedText}</a>`;
    }
    
    return formattedText;
  }).join('');
}

/**
 * HTML íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
 */
function escapeHtml(text: string): string {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/**
 * HTML ë‚´ìš©ì„ ì•ˆì „í•˜ê²Œ ì •ì œí•˜ëŠ” í•¨ìˆ˜
 * - ì˜ëª»ëœ HTML íƒœê·¸ êµ¬ì¡° ìˆ˜ì •
 * - ë…ë¦½ì ì¸ ë‹«ëŠ” íƒœê·¸ ì œê±°
 * - ë¶ˆê· í˜•í•œ íƒœê·¸ ì²˜ë¦¬
 */
function sanitizeHtml(html: string): string {
  // ë¡œê·¸ ê¸°ë¡
  console.log('[sanitizeHtml] ì›ë³¸ HTML ì²˜ë¦¬ ì‹œì‘:', html.substring(0, 100) + (html.length > 100 ? '...' : ''));
  
  // 0. í…ìŠ¤íŠ¸ë¡œ ì‘ì„±ëœ HTML íƒœê·¸ ì²˜ë¦¬ (ì˜ˆ: &lt;figure&gt;)
  let sanitized = html.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
  
  // 1. ë…ë¦½ì ì¸ ë‹«ëŠ” íƒœê·¸ ì œê±° (</tag>)
  sanitized = sanitized.replace(/<\/[a-zA-Z][a-zA-Z0-9]*\s*>/g, (match) => {
    console.log(`[sanitizeHtml] ë…ë¦½ ë‹«ëŠ” íƒœê·¸ ì œê±°: ${match}`);
    return '';
  });
  
  // 2. ë¹ˆ íƒœê·¸ ì •ë¦¬ (<tag></tag> -> <tag />)
  sanitized = sanitized.replace(/<([a-zA-Z][a-zA-Z0-9]*)[^>]*><\/\1\s*>/g, '<$1 />');
  
  // 3. íŠ¹ìˆ˜í•œ ê²½ìš°: figureì™€ ê´€ë ¨ëœ ë¬¸ì œ íŠ¹ë³„ ì²˜ë¦¬
  if (sanitized.includes('</figure>') && !sanitized.includes('<figure')) {
    console.log('[sanitizeHtml] ë¶ˆê· í˜• figure íƒœê·¸ ë°œê²¬: ë‹«ëŠ” íƒœê·¸ ì œê±°');
    sanitized = sanitized.replace(/<\/figure\s*>/g, '');
  }
  
  // 4. XSS ë°©ì§€: script íƒœê·¸ ì œê±°
  sanitized = sanitized.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
  
  // 5. íƒœê·¸ ê· í˜• ê²€ì‚¬ ë° ë³µêµ¬
  sanitized = balanceHtmlTags(sanitized);
  
  // 6. í…ìŠ¤íŠ¸ë¡œ ë‚¨ì•„ìˆëŠ” HTML íƒœê·¸ ì²˜ë¦¬
  sanitized = handlePlainTextTags(sanitized);
  
  // ì²˜ë¦¬ ê²°ê³¼ ë¡œê·¸
  console.log('[sanitizeHtml] ì •ì œëœ HTML:', sanitized.substring(0, 100) + (sanitized.length > 100 ? '...' : ''));
  
  return sanitized;
}

/**
 * í…ìŠ¤íŠ¸ ë‚´ HTML íƒœê·¸ì²˜ëŸ¼ ë³´ì´ëŠ” ë‚´ìš© ì²˜ë¦¬
 * - ì´ë¯¸ íŒŒì‹±ëœ íƒœê·¸ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë³€í™˜
 */
function handlePlainTextTags(html: string): string {
  // HTML íŒŒì„œë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ í…ìŠ¤íŠ¸ ì˜ì—­ ì‹ë³„
  const parts: {isTag: boolean, content: string}[] = [];
  let insideTag = false;
  let current = '';
  
  for (let i = 0; i < html.length; i++) {
    const char = html[i];
    
    if (char === '<') {
      // íƒœê·¸ ì‹œì‘
      if (current) {
        parts.push({isTag: insideTag, content: current});
        current = '';
      }
      insideTag = true;
      current += char;
    } else if (char === '>' && insideTag) {
      // íƒœê·¸ ì¢…ë£Œ
      current += char;
      parts.push({isTag: true, content: current});
      current = '';
      insideTag = false;
    } else {
      current += char;
    }
  }
  
  if (current) {
    parts.push({isTag: insideTag, content: current});
  }
  
  // í…ìŠ¤íŠ¸ ë¶€ë¶„ì—ì„œë§Œ < > ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
  return parts.map(part => {
    if (!part.isTag) {
      // </figure> í…ìŠ¤íŠ¸ê°€ í¬í•¨ëœ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
      if (part.content.includes('</figure>')) {
        console.log('[handlePlainTextTags] í…ìŠ¤íŠ¸ ë‚´ ë‹«ëŠ” figure íƒœê·¸ ë°œê²¬, ì œê±°');
        return part.content.replace(/\<\/figure\>/g, '');
      }
      
      // ì¼ë°˜ í…ìŠ¤íŠ¸ ë‚´ < > ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
      return part.content
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
    return part.content;
  }).join('');
}

/**
 * HTML íƒœê·¸ ê· í˜•ì„ ë§ì¶”ëŠ” í•¨ìˆ˜
 * - ì—´ë¦¬ëŠ” íƒœê·¸ì™€ ë‹«íˆëŠ” íƒœê·¸ì˜ ê· í˜• í™•ì¸
 * - ë¶ˆê· í˜•í•œ íƒœê·¸ ì œê±° ë˜ëŠ” ì¶”ê°€
 */
function balanceHtmlTags(html: string): string {
  console.log('[balanceHtmlTags] íƒœê·¸ ê· í˜• ê²€ì‚¬ ì‹œì‘');
  
  // í—ˆìš©í•  íƒœê·¸ ëª©ë¡ (ìì²´ ë‹«ê¸° íƒœê·¸ ì œì™¸)
  const allowedTags = [
    'div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
    'ul', 'ol', 'li', 'blockquote', 'pre', 'code',
    'table', 'tr', 'td', 'th', 'thead', 'tbody',
    'a', 'strong', 'em', 'b', 'i', 'u', 'strike', 'del',
    'figure', 'figcaption', 'img', 'iframe', 'video', 'audio'
  ];
  
  // ìì²´ ë‹«ëŠ” íƒœê·¸ (ë‹«ëŠ” íƒœê·¸ê°€ í•„ìš”ì—†ëŠ” íƒœê·¸)
  const selfClosingTags = ['img', 'br', 'hr', 'input', 'meta', 'link'];
  
  // íƒœê·¸ ìŠ¤íƒ (ì—´ë¦° íƒœê·¸ë¥¼ ì¶”ì )
  const tagStack: string[] = [];
  
  // ì •ê·œì‹ìœ¼ë¡œ ëª¨ë“  íƒœê·¸ ì°¾ê¸°
  const tagPattern = /<\/?([a-zA-Z][a-zA-Z0-9]*)[^>]*>/g;
  
  // íƒœê·¸ ê· í˜• ë¶„ì„
  let match;
  let processedHtml = html;
  let imbalancedTags: {tag: string, isOpening: boolean}[] = [];
  
  while ((match = tagPattern.exec(html)) !== null) {
    const fullTag = match[0];
    const tagName = match[1].toLowerCase();
    const isClosingTag = fullTag.startsWith('</');
    const isSelfClosing = selfClosingTags.includes(tagName) || fullTag.endsWith('/>');
    
    // ë¬´ì‹œí•  íƒœê·¸ë¼ë©´ ê±´ë„ˆë›°ê¸°
    if (!allowedTags.includes(tagName) && !selfClosingTags.includes(tagName)) {
      continue;
    }
    
    if (!isClosingTag && !isSelfClosing) {
      // ì—¬ëŠ” íƒœê·¸ ìŠ¤íƒì— ì¶”ê°€
      tagStack.push(tagName);
    } else if (isClosingTag) {
      // ë‹«ëŠ” íƒœê·¸ ì²˜ë¦¬
      if (tagStack.length === 0) {
        // ë‹«ëŠ” íƒœê·¸ì¸ë° ìŠ¤íƒì´ ë¹„ì–´ìˆìœ¼ë©´ ë¶ˆê· í˜• (ì œê±° ëŒ€ìƒ)
        imbalancedTags.push({tag: tagName, isOpening: false});
        console.log(`[balanceHtmlTags] ë¶ˆê· í˜• ë‹«ëŠ” íƒœê·¸ ë°œê²¬: ${fullTag}`);
      } else if (tagStack[tagStack.length - 1] !== tagName) {
        // ë§ˆì§€ë§‰ ì—¬ëŠ” íƒœê·¸ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ë‹«ëŠ” íƒœê·¸ (ë¶ˆê· í˜•)
        imbalancedTags.push({tag: tagName, isOpening: false});
        console.log(`[balanceHtmlTags] ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ë‹«ëŠ” íƒœê·¸: ${fullTag}, ì˜ˆìƒ: ${tagStack[tagStack.length - 1]}`);
      } else {
        // ì •ìƒì ì¸ ë‹«ëŠ” íƒœê·¸
        tagStack.pop();
      }
    }
  }
  
  // ë‹«íˆì§€ ì•Šì€ íƒœê·¸ ì²˜ë¦¬
  for (let i = tagStack.length - 1; i >= 0; i--) {
    const unclosedTag = tagStack[i];
    imbalancedTags.push({tag: unclosedTag, isOpening: true});
    console.log(`[balanceHtmlTags] ë‹«íˆì§€ ì•Šì€ íƒœê·¸ ë°œê²¬: ${unclosedTag}`);
  }
  
  // ë¶ˆê· í˜• íƒœê·¸ ì²˜ë¦¬
  if (imbalancedTags.length > 0) {
    console.log(`[balanceHtmlTags] ${imbalancedTags.length}ê°œì˜ ë¶ˆê· í˜• íƒœê·¸ ë°œê²¬, ì²˜ë¦¬ ì¤‘...`);
    
    // ë…ë¦½ì ì¸ ë‹«ëŠ” íƒœê·¸ ì œê±° (ì—´ë¦¬ì§€ ì•Šì€ íƒœê·¸)
    imbalancedTags.filter(item => !item.isOpening).forEach(item => {
      const closingTagPattern = new RegExp(`</${item.tag}[^>]*>`, 'g');
      processedHtml = processedHtml.replace(closingTagPattern, '');
      console.log(`[balanceHtmlTags] ë¶ˆê· í˜• ë‹«ëŠ” íƒœê·¸ ì œê±°: ${item.tag}`);
    });
    
    // íŠ¹ë³„ ì²˜ë¦¬: íŠ¹ì • íƒœê·¸ì— ëŒ€í•´ì„œë§Œ ë‹«ëŠ” íƒœê·¸ ì¶”ê°€ (í•„ìš”í•œ ê²½ìš°)
    const importantTags = ['div', 'figure', 'table', 'ul', 'ol'];
    imbalancedTags.filter(item => item.isOpening && importantTags.includes(item.tag)).forEach(item => {
      processedHtml += `</${item.tag}>`;
      console.log(`[balanceHtmlTags] ë‹«ëŠ” íƒœê·¸ ì¶”ê°€: ${item.tag}`);
    });
  }
  
  return processedHtml;
}

/**
 * ë‹¨ì¼ ë¸”ë¡ì„ HTMLë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
 */
export function renderBlock(
  block: ExtendedBlockObjectResponse & { children?: ExtendedBlockObjectResponse[] },
  locale: string = 'ko'
): string {
  // html ë¸”ë¡ì¼ ê²½ìš° ì •ì œ í›„ HTMLì„ ë°˜í™˜
  if ((block as any).type === 'html') {
    console.log('[renderBlock] HTML ë¸”ë¡ ë Œë”ë§:', block.id);
    // HTML ë¸”ë¡ì˜ ë‚´ìš©ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ë Œë”ë§
    if ((block as any).html?.rich_text?.length > 0) {
      const htmlContent = (block as any).html.rich_text.map((text: any) => text.plain_text).join('');
      
      // HTML ë‚´ìš© ì •ì œ - ì•ˆì „í™” ìˆ˜í–‰
      const sanitizedHtml = sanitizeHtml(htmlContent);
      
      console.log('[renderBlock] HTML ë‚´ìš© ì •ì œ ì „/í›„ ë¹„êµ:');
      console.log('- ì •ì œ ì „:', htmlContent.substring(0, 100) + (htmlContent.length > 100 ? '...' : ''));
      console.log('- ì •ì œ í›„:', sanitizedHtml.substring(0, 100) + (sanitizedHtml.length > 100 ? '...' : ''));
      
      // ì¤‘ìš”: HTML ë¸”ë¡ì— íƒœê·¸ê°€ í…ìŠ¤íŠ¸ë¡œ í¬í•¨ëœ ê²½ìš° (ì˜ˆ: <figure> íƒœê·¸ê°€ í…ìŠ¤íŠ¸ë¡œ í¬í•¨ëœ ê²½ìš°)
      // HTML ë¸”ë¡ ë‚´ìš©ì„ ì‹¤ì œ HTMLë¡œ í•´ì„í•˜ì—¬ ë°˜í™˜
      if (sanitizedHtml.includes('&lt;figure') || 
          sanitizedHtml.includes('&lt;img') || 
          sanitizedHtml.includes('<figure') ||
          sanitizedHtml.includes('<img')) {
            
        console.log('[renderBlock] HTML ë¸”ë¡ì— ì´ë¯¸ì§€/figure íƒœê·¸ ê°ì§€, HTMLë¡œ í•´ì„');
        
        // HTML ì—”í‹°í‹° ë””ì½”ë”© (ì˜ˆ: &lt; -> <)
        let decodedHtml = sanitizedHtml
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&amp;/g, '&')
          .replace(/&quot;/g, '"')
          .replace(/&#39;/g, "'");
          
        // XSS ìœ„í—˜ ìš”ì†Œ ì œê±° (script íƒœê·¸ ë“±)
        decodedHtml = decodedHtml.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
        
        // ì´ë¯¸ì§€ íƒœê·¸ì— ìŠ¤íƒ€ì¼ ë° ë³´ì•ˆ ì†ì„± ì¶”ê°€
        decodedHtml = decodedHtml.replace(/<img\s+/gi, '<img loading="lazy" onerror="this.onerror=null; this.src=\'/images/placeholder.jpg\'; console.error(\'ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:\', this.src);" ');
        
        console.log('[renderBlock] ìµœì¢… HTML í•´ì„ ê²°ê³¼:', decodedHtml.substring(0, 100) + (decodedHtml.length > 100 ? '...' : ''));
        
        // ë””ì½”ë”©ëœ HTML ë°˜í™˜ (ì‹¤ì œ HTMLë¡œ í•´ì„ë¨)
        return decodedHtml;
      }
      
      // ì •ì œëœ HTML ë°˜í™˜
      return sanitizedHtml;
    }
    return '<div class="notion-html-empty">ë¹ˆ HTML ë¸”ë¡</div>';
  }

  const { type, id } = block;
  const value = block[type as keyof typeof block];

  if (!value) {
    console.warn(`[renderBlock] ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡ íƒ€ì…: ${type}, ID: ${id}`);
    return `<div class="notion-unknown-block">ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡ ìœ í˜•: ${type}</div>`;
  }

  let html = '';

  switch (type) {
    case 'paragraph':
      html = `<p class="my-2">${renderRichText((value as any).rich_text)}</p>`;
      break;
      
    case 'heading_1':
      html = `<h1 class="text-3xl font-bold my-4">${renderRichText((value as any).rich_text)}</h1>`;
      break;
      
    case 'heading_2':
      html = `<h2 class="text-2xl font-bold my-3">${renderRichText((value as any).rich_text)}</h2>`;
      break;
      
    case 'heading_3':
      html = `<h3 class="text-xl font-bold my-2">${renderRichText((value as any).rich_text)}</h3>`;
      break;
      
    case 'bulleted_list_item':
      html = `<li class="mb-1">${renderRichText((value as any).rich_text)}</li>`;
      break;
      
    case 'numbered_list_item':
      html = `<li class="mb-1">${renderRichText((value as any).rich_text)}</li>`;
      break;
      
    case 'quote':
      html = `<blockquote class="border-l-4 border-gray-300 pl-4 italic my-4">${renderRichText((value as any).rich_text)}</blockquote>`;
      break;
      
    case 'code':
      const codeContent = renderRichText((value as any).rich_text);
      const language = (value as any).language || 'plaintext';
      html = `<pre class="my-4 p-4 bg-gray-100 rounded overflow-x-auto"><code class="language-${language}">${codeContent}</code></pre>`;
      break;
      
    case 'image':
      const image = (value as any).image;
      let src = '';
      
      if (image.file?.url) {
        src = image.file.url;
      } else if (image.external?.url) {
        src = image.external.url;
      }
      
      const caption = renderRichText(image.caption) || '';
      
      if (src) {
        if (caption) {
          // ìº¡ì…˜ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ figure íƒœê·¸ ì‚¬ìš©
          html = `
            <figure class="my-8 text-center">
              <img src="${escapeHtml(src)}" alt="${caption || 'Image'}" class="max-w-full h-auto inline-block rounded" loading="lazy" onerror="this.onerror=null; this.src='/images/placeholder.jpg'; console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${escapeHtml(src)}');" />
              <figcaption class="text-sm text-gray-500 mt-2">${caption}</figcaption>
            </figure>
          `;
        } else {
          // ìº¡ì…˜ì´ ì—†ëŠ” ê²½ìš° div ì‚¬ìš©
          html = `
            <div class="my-8 text-center">
              <img src="${escapeHtml(src)}" alt="Image" class="max-w-full h-auto inline-block rounded" loading="lazy" onerror="this.onerror=null; this.src='/images/placeholder.jpg'; console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${escapeHtml(src)}');" />
            </div>
          `;
        }
      } else {
        html = `<div class="p-4 my-4 bg-red-50 text-red-500 rounded">ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜ (ì†ŒìŠ¤ ì—†ìŒ)</div>`;
      }
      break;
      
    case 'video':
      const video = (value as any).video;
      const videoSrc = video.file?.url || video.external?.url;
      const videoCaption = renderRichText(video.caption) || '';
      
      if (videoSrc) {
        if (videoCaption) {
          // ìº¡ì…˜ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ figure íƒœê·¸ ì‚¬ìš©
          html = `
            <figure class="my-8">
              <video controls class="w-full rounded" src="${escapeHtml(videoSrc)}" loading="lazy"></video>
              <figcaption class="text-sm text-gray-500 mt-2">${videoCaption}</figcaption>
            </figure>
          `;
        } else {
          // ìº¡ì…˜ì´ ì—†ëŠ” ê²½ìš° div ì‚¬ìš©
          html = `
            <div class="my-8">
              <video controls class="w-full rounded" src="${escapeHtml(videoSrc)}" loading="lazy"></video>
            </div>
          `;
        }
      } else {
        html = `<div class="p-4 my-4 bg-red-50 text-red-500 rounded">ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜</div>`;
      }
      break;
      
    case 'divider':
      html = `<hr class="my-8" />`;
      break;
      
    case 'callout':
      const callout = (value as any).callout;
      const icon = callout.icon?.type === 'emoji' ? callout.icon.emoji : 'ğŸ’¡';
      
      html = `
        <div class="bg-gray-100 p-4 my-4 rounded flex items-start">
          <span class="mr-2">${icon}</span>
          <div>
            ${renderRichText(callout.rich_text)}
          </div>
        </div>
      `;
      break;
      
    case 'bookmark':
      const bookmark = (value as any).bookmark;
      
      html = `
        <div class="my-4 border p-4 rounded block hover:bg-gray-50">
          <a href="${escapeHtml(bookmark.url)}" target="_blank" rel="noopener noreferrer">
            <p class="font-semibold truncate">${renderRichText(bookmark.caption) || escapeHtml(bookmark.url)}</p>
            <p class="text-sm text-gray-500 truncate">${escapeHtml(bookmark.url)}</p>
          </a>
        </div>
      `;
      break;
      
    case 'table':
      html = `
        <div class="overflow-x-auto my-4">
          <table class="w-full border-collapse border border-gray-300">
            ${renderBlocksToHtml(value as (BlockObjectResponse & { children?: BlockObjectResponse[] })[])}
          </table>
        </div>
      `;
      break;
      
    case 'table_row':
      const cells = (value as any).cells;
      
      html = `
        <tr>
          ${cells.map((cell: any) => `<td class="border border-gray-300 p-2">${renderRichText(cell)}</td>`).join('')}
        </tr>
      `;
      break;
      
    case 'toggle':
      html = `
        <details class="my-2">
          <summary class="cursor-pointer font-medium">${renderRichText((value as any).rich_text)}</summary>
          <div class="mt-1">
            ${renderBlocksToHtml(value as (BlockObjectResponse & { children?: BlockObjectResponse[] })[])}
          </div>
        </details>
      `;
      break;
      
    case 'child_page':
      html = `<div class="my-2 p-2 border rounded bg-gray-50">ğŸ“„ ${escapeHtml((value as any).title)}</div>`;
      break;
      
    case 'child_database':
      html = `<div class="my-4 p-2 border rounded bg-gray-50">ğŸ’¾ ${escapeHtml((value as any).title)}</div>`;
      break;
      
    case 'embed':
      const embed = (value as any).embed;
      const embedCaption = renderRichText(embed.caption) || '';
      
      if (embedCaption) {
        // ìº¡ì…˜ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ figure íƒœê·¸ ì‚¬ìš©
        html = `
          <figure class="my-8">
            <iframe src="${escapeHtml(embed.url)}" class="w-full h-96 border-0" allowfullscreen loading="lazy"></iframe>
            <figcaption class="text-sm text-gray-500 mt-2">${embedCaption}</figcaption>
          </figure>
        `;
      } else {
        // ìº¡ì…˜ì´ ì—†ëŠ” ê²½ìš° div ì‚¬ìš©
        html = `
          <div class="my-8">
            <iframe src="${escapeHtml(embed.url)}" class="w-full h-96 border-0" allowfullscreen loading="lazy"></iframe>
          </div>
        `;
      }
      break;
      
    case 'equation':
      html = `<div class="my-2 text-center" data-equation="${escapeHtml((value as any).expression)}">[Equation: ${escapeHtml((value as any).expression)}]</div>`;
      break;
      
    case 'file':
      const file = (value as any).file;
      const fileUrl = file.file?.url || file.external?.url;
      const fileName = renderRichText(file.caption) || file.name || 'Download File';
      
      html = `
        <div class="my-4 p-2 border rounded flex items-center">
          <span class="mr-2"></span>
          <a href="${escapeHtml(fileUrl)}" target="_blank" rel="noopener noreferrer" class="hover:underline">${escapeHtml(fileName)}</a>
        </div>
      `;
      break;
      
    case 'synced_block':
      // ë™ê¸°í™”ëœ ë¸”ë¡ì˜ ê²½ìš° ìì‹ ë¸”ë¡ë“¤ì„ ì§ì ‘ ë Œë”ë§
      html = renderBlocksToHtml(value as (BlockObjectResponse & { children?: BlockObjectResponse[] })[]);
      break;
      
    case 'unsupported':
      console.warn(`ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡ íƒ€ì…: ${id}`);
      html = `<p class="p-2 my-2 bg-yellow-50 text-yellow-700 rounded">[ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡ íƒ€ì…]</p>`;
      break;
      
    default:
      console.warn(`ì²˜ë¦¬ë˜ì§€ ì•Šì€ ë¸”ë¡ íƒ€ì…: ${type} (ID: ${id})`);
      
      // ê¸°ë³¸ì ìœ¼ë¡œ rich_textê°€ ìˆìœ¼ë©´ í‘œì‹œ ì‹œë„
      const richText = (value as any)[type]?.rich_text;
      if (richText) {
        html = `<div>${renderRichText(richText)}</div>`;
      } else {
        html = `<div class="p-4 my-4 bg-red-50 text-red-500 rounded">ì•Œ ìˆ˜ ì—†ëŠ” ë¸”ë¡: ${type}</div>`;
      }
  }

  return html;
}

/**
 * ë¸”ë¡ ë°°ì—´ì„ HTMLë¡œ ë³€í™˜í•˜ë©° ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹í™” ì²˜ë¦¬
 */
export function renderBlocksToHtmlWithListHandling(blocks: (BlockObjectResponse & { children?: BlockObjectResponse[] })[]): string {
  let html = '';
  let currentListTag: 'ul' | 'ol' | null = null;
  let listItems = '';
  
  // ë””ë²„ê¹…ì„ ìœ„í•œ ë¸”ë¡ ì •ë³´ ë¡œê¹…
  console.log(`[renderBlocksToHtmlWithListHandling] ì´ ${blocks.length}ê°œ ë¸”ë¡ ì²˜ë¦¬ ì‹œì‘`);
  
  // ë¸”ë¡ ë°ì´í„° ìˆœíšŒí•˜ë©°, figure ê´€ë ¨ ë¸”ë¡ ì‹ë³„
  let hasFigureIssue = false;
  const problematicBlocks: any[] = [];
  
  blocks.forEach((block, index) => {
    // ë¸”ë¡ ë‚´ìš© ë¡œê¹… (ì²« 10ê°œì™€ ë§ˆì§€ë§‰ 10ê°œë§Œ)
    if (index < 10 || index >= blocks.length - 10) {
      console.log(`[Block ${index}] Type: ${block.type}, ID: ${block.id}`);
      
      // ì˜ì‹¬ë˜ëŠ” ë¸”ë¡ í™•ì¸ (ì´ë¯¸ì§€ ë¸”ë¡ê³¼ HTML ë¸”ë¡)
      if (block.type === 'image' || 
          (block as any).type === 'html' || 
          (typeof block.type === 'string' && block.type.includes('figure'))) {
        console.log(`[ì˜ì‹¬ ë¸”ë¡ ${index}] ìƒì„¸:`, JSON.stringify(block).substring(0, 300));
        
        // í…ìŠ¤íŠ¸ì— figure ê´€ë ¨ ë‚´ìš© í¬í•¨ ì—¬ë¶€ í™•ì¸
        if ((block as any).type === 'html' && 
            (block as any).html?.rich_text?.some((text: any) => 
              text.plain_text?.includes('figure') || 
              text.plain_text?.includes('</figure>')
            )) {
          hasFigureIssue = true;
          problematicBlocks.push({index, block});
          console.log(`[ë¬¸ì œ ë°œê²¬] ë¸”ë¡ ${index}ì— figure ê´€ë ¨ HTML í…ìŠ¤íŠ¸ í¬í•¨`);
        }
      }
    }
    
    const blockType = block.type;
    const isListItem = blockType === 'bulleted_list_item' || blockType === 'numbered_list_item';
    const listType = blockType === 'bulleted_list_item' ? 'ul' : 'ol';
    
    if (isListItem) {
      // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì˜ ê²½ìš°
      if (currentListTag !== listType) {
        // ì´ì „ ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë‹«ê¸°
        if (currentListTag) {
          html += `</${currentListTag}>\n`;
        }
        
        // ìƒˆ ë¦¬ìŠ¤íŠ¸ ì‹œì‘
        const listClass = listType === 'ul' ? 'list-disc' : 'list-decimal';
        html += `<${listType} class="${listClass} ml-4 my-2">\n`;
        currentListTag = listType;
      }
      
      // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€
      listItems += renderBlock(block as ExtendedBlockObjectResponse & { children?: ExtendedBlockObjectResponse[] });
    } else {
      // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì´ ì•„ë‹Œ ê²½ìš°
      if (currentListTag) {
        // ì§„í–‰ ì¤‘ì¸ ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€ í›„ ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
        html += listItems + `</${currentListTag}>\n`;
        currentListTag = null;
        listItems = '';
      }
      
      // ì¼ë°˜ ë¸”ë¡ ì¶”ê°€
      const renderedBlock = renderBlock(block as ExtendedBlockObjectResponse & { children?: ExtendedBlockObjectResponse[] });
      
      // </figure> í…ìŠ¤íŠ¸ ì§ì ‘ ì œê±° (ìµœí›„ì˜ ìˆ˜ë‹¨)
      if (renderedBlock.includes('</figure>') && !renderedBlock.includes('<figure')) {
        console.log(`[êµì • ì ìš©] ë¸”ë¡ ${index}ì—ì„œ ë…ë¦½ì ì¸ </figure> íƒœê·¸ ì œê±°`);
        html += renderedBlock.replace(/<\/figure>/g, '');
      } else {
        html += renderedBlock;
      }
    }
  });
  
  // ë§ˆì§€ë§‰ ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
  if (currentListTag) {
    html += listItems + `</${currentListTag}>\n`;
  }
  
  // ë¬¸ì œ ë°œê²¬ ì‹œ ìš”ì•½ ë¡œê¹…
  if (hasFigureIssue) {
    console.log(`[figure ë¬¸ì œ ê°ì§€] ${problematicBlocks.length}ê°œ ë¸”ë¡ì—ì„œ ë¬¸ì œ ë°œê²¬. ë¬¸ì œ ID: ${problematicBlocks.map(p => p.block.id).join(', ')}`);
  }
  
  // ìµœì¢… ê²°ê³¼ì—ì„œ ë…ë¦½ì ì¸ </figure> íƒœê·¸ í•œ ë²ˆ ë” ì œê±° (ë¹„ìƒ ì²˜ë¦¬)
  const cleanedHtml = html.replace(/<\/figure>\s*(?!<)/g, '');
  
  return cleanedHtml;
}

/**
 * HTML ë¬¸ìì—´ì—ì„œ ê³ ì•„ íƒœê·¸(ì—¬ëŠ” íƒœê·¸ ì—†ì´ ë‹«ëŠ” íƒœê·¸ë§Œ ìˆëŠ”) ì œê±°
 */
function removeOrphanedClosingTags(html: string, tagName: string): string {
  console.log(`ğŸ” '${tagName}' ê³ ì•„ íƒœê·¸ ì œê±° ì‹œì‘`);
  
  // íƒœê·¸ ì¹´ìš´íŠ¸ë¥¼ ìœ„í•œ ì •ê·œì‹ íŒ¨í„´
  const openTagPattern = new RegExp(`<${tagName}[^>]*>`, 'g');
  const closeTagPattern = new RegExp(`</${tagName}\\s*>`, 'g');
  
  // ì—¬ëŠ” íƒœê·¸ì™€ ë‹«ëŠ” íƒœê·¸ ì¹´ìš´íŠ¸
  const openMatches = html.match(openTagPattern) || [];
  const closeMatches = html.match(closeTagPattern) || [];
  
  const openCount = openMatches.length;
  const closeCount = closeMatches.length;
  
  console.log(`ğŸ“Š íƒœê·¸ ê· í˜•: ${openCount}ê°œ ì—¬ëŠ” íƒœê·¸, ${closeCount}ê°œ ë‹«ëŠ” íƒœê·¸`);
  
  if (closeCount > openCount) {
    console.log(`âš ï¸ ${closeCount - openCount}ê°œì˜ ê³ ì•„ ë‹«ëŠ” íƒœê·¸ ë°œê²¬, ì œê±° ì¤‘...`);
    
    // ëª¨ë“  ë‹«ëŠ” íƒœê·¸ë¥¼ ì°¾ì•„ì„œ ê· í˜• ë§ì¶”ê¸°
    let processedHtml = html;
    let currentOpenCount = openCount;
    
    // ë‹«ëŠ” íƒœê·¸ë¥¼ ì°¾ì„ ë•Œë§ˆë‹¤ ì²˜ë¦¬
    let match;
    let tempHtml = processedHtml;
    const foundIndices: number[] = [];
    
    while ((match = closeTagPattern.exec(tempHtml)) !== null) {
      if (currentOpenCount <= 0) {
        // ê³ ì•„ íƒœê·¸ ë°œê²¬
        foundIndices.push(match.index);
      } else {
        // ì •ìƒì ì¸ ë‹«ëŠ” íƒœê·¸
        currentOpenCount--;
      }
    }
    
    // ê³ ì•„ íƒœê·¸ ì œê±° (ë’¤ì—ì„œë¶€í„° ì œê±°í•´ì„œ ì¸ë±ìŠ¤ ë³€í™” ìµœì†Œí™”)
    for (let i = foundIndices.length - 1; i >= 0; i--) {
      const index = foundIndices[i];
      processedHtml = processedHtml.substring(0, index) + 
                     processedHtml.substring(index + `</${tagName}>`.length);
    }
    
    console.log(`âœ… ${foundIndices.length}ê°œì˜ ê³ ì•„ íƒœê·¸ ì œê±° ì™„ë£Œ`);
    return processedHtml;
  }
  
  // ê· í˜•ì´ ë§ëŠ” ê²½ìš° ì›ë˜ HTML ë°˜í™˜
  return html;
}