import {
  BlockObjectResponse,
  PartialBlockObjectResponse,
  RichTextItemResponse
} from '@notionhq/client/build/src/api-endpoints';
import { notion } from './client';
import { countBlockTypes, findFirstImage, escapeHTML, isEmoji } from './utils';

// NotionToMarkdown ì¸ìŠ¤í„´ìŠ¤ (í•„ìš”í•œ ê²½ìš° ì‚¬ìš©)
// import { NotionToMarkdown } from 'notion-to-md';
// const n2m = new NotionToMarkdown({ notionClient: notion });


/**
 * íŠ¹ì • ë¸”ë¡ì˜ í•˜ìœ„ ë¸”ë¡ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
 */
export async function getBlocks(blockId: string): Promise<(BlockObjectResponse | PartialBlockObjectResponse)[]> {
  try {
    console.log(`ğŸ§± ë¸”ë¡ ìì‹ ì¡°íšŒ ì‹œì‘: ${blockId}`);
    const response = await notion.blocks.children.list({
      block_id: blockId,
      page_size: 100, // ìµœëŒ€ 100ê°œ, í˜ì´ì§€ë„¤ì´ì…˜ í•„ìš” ì‹œ êµ¬í˜„
    });
    console.log(`ğŸ§± ë¸”ë¡ ${blockId}ì˜ ìì‹ ${response.results.length}ê°œ ì¡°íšŒ ì™„ë£Œ`);
    return response.results;
  } catch (error) {
    console.error(`ğŸ”´ ë¸”ë¡ ${blockId} ìì‹ ì¡°íšŒ ì˜¤ë¥˜:`, error);
    return [];
  }
}

/**
 * í˜ì´ì§€ì˜ ëª¨ë“  ë¸”ë¡ì„ ì¬ê·€ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
 * (ì£¼ì˜: í˜ì´ì§€ê°€ ë§¤ìš° í¬ë©´ API í˜¸ì¶œ ì œí•œì— ê±¸ë¦´ ìˆ˜ ìˆìŒ)
 */
export async function getPageBlocks(pageId: string): Promise<BlockObjectResponse[]> {
    console.log(`ğŸ“„ í˜ì´ì§€ ${pageId}ì˜ ëª¨ë“  ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œì‘`);
    const allBlocks: BlockObjectResponse[] = [];
    let hasMore = true;
    let startCursor: string | undefined = undefined;

    // ìµœìƒìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° (í˜ì´ì§€ëŠ” ë¸”ë¡ì˜ ì¼ì¢…)
    try {
        while(hasMore) {
            const response = await notion.blocks.children.list({
                block_id: pageId,
                page_size: 100, // í˜ì´ì§€ë‹¹ ë¸”ë¡ ìˆ˜ (ìµœëŒ€ 100)
                start_cursor: startCursor,
            });

            const fetchedBlocks = response.results.filter(
                (block): block is BlockObjectResponse => 'type' in block
            );
            console.log(`ğŸ“„ í˜ì´ì§€ ${pageId}ì—ì„œ ë¸”ë¡ ${fetchedBlocks.length}ê°œ ê°€ì ¸ì˜´ (ì»¤ì„œ: ${startCursor ?? 'ì—†ìŒ'})`);

            allBlocks.push(...fetchedBlocks);

            hasMore = response.has_more;
            startCursor = response.next_cursor ?? undefined;

            if (startCursor) {
                 console.log(`ğŸ“„ ë‹¤ìŒ í˜ì´ì§€ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œë„ (ì»¤ì„œ: ${startCursor})`);
            }
        }

        console.log(`ğŸ“„ í˜ì´ì§€ ${pageId}ì˜ ìµœìƒìœ„ ë¸”ë¡ ì´ ${allBlocks.length}ê°œ í™•ë³´`);

        // ê° ë¸”ë¡ì— ëŒ€í•´ í•˜ìœ„ ë¸”ë¡ ì¬ê·€ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
        console.log(`ğŸŒ³ í•˜ìœ„ ë¸”ë¡ ì¬ê·€ íƒìƒ‰ ì‹œì‘ (ìµœëŒ€ ê¹Šì´: ${MAX_DEPTH})`);
        const populatedBlocks = await populateChildBlocks(allBlocks);
        console.log(`ğŸŒ³ í•˜ìœ„ ë¸”ë¡ íƒìƒ‰ ì™„ë£Œ. ì´ ì²˜ë¦¬ëœ ë¸”ë¡ ìˆ˜: ${countTotalBlocks(populatedBlocks)}`);

        return populatedBlocks;

    } catch (error) {
        console.error(`ğŸ”´ í˜ì´ì§€ ${pageId} ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:`, error);
        return []; // ì˜¤ë¥˜ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
    }
}

const MAX_DEPTH = 5; // ì¬ê·€ í˜¸ì¶œ ìµœëŒ€ ê¹Šì´ ì œí•œ

async function populateChildBlocks(blocks: BlockObjectResponse[], depth = 0): Promise<BlockObjectResponse[]> {
    if (depth > MAX_DEPTH) {
        console.warn(`âš ï¸ ìµœëŒ€ ì¬ê·€ ê¹Šì´ ${MAX_DEPTH} ë„ë‹¬. ë” ì´ìƒ í•˜ìœ„ ë¸”ë¡ì„ ê°€ì ¸ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
        return blocks;
    }

    const populatedBlocks: BlockObjectResponse[] = [];

    for (const block of blocks) {
        if (block.has_children) {
            console.log(`ğŸŒ³ [ê¹Šì´ ${depth}] ë¸”ë¡ ${block.id.substring(0,8)}... (${block.type})ì˜ í•˜ìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°`);
            try {
                const childBlocks = await getPageBlocksRecursive(block.id, depth + 1);
                // Add children to the block object itself for easier processing later
                (block as any).children = childBlocks;
                 console.log(`ğŸŒ³ [ê¹Šì´ ${depth}] ë¸”ë¡ ${block.id.substring(0,8)}... (${block.type})ì— í•˜ìœ„ ë¸”ë¡ ${childBlocks.length}ê°œ ì¶”ê°€ë¨`);
            } catch(error) {
                console.error(`ğŸ”´ [ê¹Šì´ ${depth}] ë¸”ë¡ ${block.id} í•˜ìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:`, error);
                 (block as any).children = []; // ì‹¤íŒ¨ ì‹œ ë¹ˆ ë°°ì—´ í• ë‹¹
            }
        }
        populatedBlocks.push(block);
    }
    return populatedBlocks;
}


// getPageBlocksì˜ ë‚´ë¶€ ì¬ê·€ í—¬í¼ í•¨ìˆ˜
async function getPageBlocksRecursive(blockId: string, depth: number): Promise<BlockObjectResponse[]> {
    if (depth > MAX_DEPTH) {
         console.warn(`âš ï¸ ìµœëŒ€ ì¬ê·€ ê¹Šì´ ${MAX_DEPTH} ë„ë‹¬ (Block ID: ${blockId}).`);
         return [];
    }

    let allChildBlocks: BlockObjectResponse[] = [];
    let hasMore = true;
    let startCursor: string | undefined = undefined;

    while (hasMore) {
        const response = await notion.blocks.children.list({
            block_id: blockId,
            page_size: 100,
            start_cursor: startCursor,
        });

        const fetchedBlocks = response.results.filter(
            (block): block is BlockObjectResponse => 'type' in block
        );
         console.log(`ğŸŒ³ [ê¹Šì´ ${depth}] ë¸”ë¡ ${blockId.substring(0,8)}... ì—ì„œ í•˜ìœ„ ë¸”ë¡ ${fetchedBlocks.length}ê°œ ê°€ì ¸ì˜´`);

        // ê°€ì ¸ì˜¨ ë¸”ë¡ë“¤ì— ëŒ€í•´ ë‹¤ì‹œ ì¬ê·€ í˜¸ì¶œ
        const populatedChildren = await populateChildBlocks(fetchedBlocks, depth); // Pass depth here
        allChildBlocks.push(...populatedChildren);


        hasMore = response.has_more;
        startCursor = response.next_cursor ?? undefined;
    }

    return allChildBlocks;
}


// ì¬ê·€ì ìœ¼ë¡œ ë¸”ë¡ ìˆ˜ë¥¼ ì„¸ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
function countTotalBlocks(blocks: any[]): number {
    if (!blocks || !Array.isArray(blocks)) return 0;
    let count = blocks.length;
    blocks.forEach(block => {
        if (block.children && Array.isArray(block.children)) {
            count += countTotalBlocks(block.children);
        }
    });
    return count;
}


/**
 * í˜ì´ì§€ ì»¨í…ì¸  ë° ì¸ë„¤ì¼ URL ê°€ì ¸ì˜¤ê¸°
 */
export async function getPageContentAndThumbnail(pageId: string): Promise<{ content: string, thumbnail: string, image: string }> {
  console.log(`ğŸ” í˜ì´ì§€ ${pageId}ì˜ ì»¨í…ì¸  ë° ì¸ë„¤ì¼ ê°€ì ¸ì˜¤ê¸° ì‹œì‘`);
  const startTime = Date.now();

  try {
    const blocks = await getPageBlocks(pageId); // ì´ì œ ì¬ê·€ì ìœ¼ë¡œ ëª¨ë“  ë¸”ë¡ì„ ê°€ì ¸ì˜´

    if (!blocks || blocks.length === 0) {
      console.warn(`âš ï¸ í˜ì´ì§€ ${pageId}ì—ì„œ ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      return { content: '<p>ì»¨í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>', thumbnail: '', image: '' };
    }

    console.log(`ğŸ“Š í˜ì´ì§€ ${pageId}ì—ì„œ ì´ ${countTotalBlocks(blocks)}ê°œ ë¸”ë¡(í•˜ìœ„ í¬í•¨) ê°€ì ¸ì˜´`);

    // ë¸”ë¡ íƒ€ì… í†µê³„ (utils ì‚¬ìš©)
    const blockTypeStats: Record<string, number> = {};
    countBlockTypes(blocks, blockTypeStats);
    console.log(`ğŸ“Š ë¸”ë¡ íƒ€ì… í†µê³„:`, blockTypeStats);


    // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì°¾ê¸° (ì¸ë„¤ì¼ìš©) (utils ì‚¬ìš©)
    let image = findFirstImage(blocks);
    let thumbnail = image; // ê¸°ë³¸ê°’

    // ì»¤ë²„ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
    try {
      const page = await notion.pages.retrieve({ page_id: pageId });
      if (page && 'cover' in page && page.cover) {
        if ('external' in page.cover && page.cover.external?.url) {
          thumbnail = page.cover.external.url;
        } else if ('file' in page.cover && page.cover.file?.url) {
          thumbnail = page.cover.file.url;
        }
         console.log(`ğŸ–¼ï¸ í˜ì´ì§€ ì»¤ë²„ ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©: ${thumbnail.substring(0, 50)}...`);
      } else {
         console.log(`ğŸ–¼ï¸ í˜ì´ì§€ ì»¤ë²„ ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ. ë³¸ë¬¸ ì²« ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©.`);
      }
    } catch (error) {
      console.error(`ğŸ”´ í˜ì´ì§€ ${pageId} ì»¤ë²„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:`, error);
    }

     console.log(`ğŸ–¼ï¸ ìµœì¢… ì¸ë„¤ì¼ URL: ${thumbnail ? thumbnail.substring(0, 50) + '...' : 'ì—†ìŒ'}`);
     console.log(`ğŸ–¼ï¸ ë³¸ë¬¸ ì²« ì´ë¯¸ì§€ URL: ${image ? image.substring(0, 50) + '...' : 'ì—†ìŒ'}`);


    // ë¸”ë¡ì„ HTMLë¡œ ë³€í™˜
    const conversionStartTime = Date.now();
    console.log(`ğŸ”„ processBlocks í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘: ${blocks.length}ê°œ ìµœìƒìœ„ ë¸”ë¡`);
    const content = await processBlocks(blocks); // HTML ë¬¸ìì—´ ì§ì ‘ ë°˜í™˜
    const conversionEndTime = Date.now();
    const conversionTime = (conversionEndTime - conversionStartTime) / 1000;

    const endTime = Date.now();
    const totalTime = (endTime - startTime) / 1000;

    console.log(`â±ï¸ ì»¨í…ì¸  ë³€í™˜ ì‹œê°„: ${conversionTime.toFixed(2)}ì´ˆ`);
    console.log(`â±ï¸ ì´ ì†Œìš” ì‹œê°„: ${totalTime.toFixed(2)}ì´ˆ`);
    console.log(`ğŸ“Š ìƒì„±ëœ HTML ê¸¸ì´: ${content.length} ê¸€ì`);

    if (content.trim() === '') {
        console.warn(`âš ï¸ í˜ì´ì§€ ${pageId} ë³€í™˜ ê²°ê³¼ HTMLì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
        return { content: '<p>ì»¨í…ì¸  ë³€í™˜ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>', thumbnail, image };
    }

    return { content, thumbnail, image };

  } catch (error) {
    console.error(`ğŸ”´ í˜ì´ì§€ ${pageId} ì»¨í…ì¸  ê°€ì ¸ì˜¤ê¸° ë° ë³€í™˜ ì˜¤ë¥˜:`, error);
    return {
      content: `<p class="notion-error">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>`,
      thumbnail: '',
      image: ''
    };
  }
}


/**
 * Rich Text ë°°ì—´ì„ HTML ë¬¸ìì—´ë¡œ ë Œë”ë§
 */
export function renderRichText(richText: any[] | undefined): string {
  if (!richText || richText.length === 0) {
    return '';
  }

  return richText
    .map((text) => {
      if (!text || typeof text !== 'object') {
        return '';
      }

      // text.plain_textê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      const plainText = text.plain_text || text.text?.content || '';
      
      if (!plainText) {
        return '';
      }

      let formattedText = plainText
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // ìŠ¤íƒ€ì¼ ì ìš©
      if (text.annotations) {
        if (text.annotations.bold) {
          formattedText = `<strong>${formattedText}</strong>`;
        }
        if (text.annotations.italic) {
          formattedText = `<em>${formattedText}</em>`;
        }
        if (text.annotations.strikethrough) {
          formattedText = `<del>${formattedText}</del>`;
        }
        if (text.annotations.underline) {
          formattedText = `<u>${formattedText}</u>`;
        }
        if (text.annotations.code) {
          formattedText = `<code>${formattedText}</code>`;
        }
      }

      // ë§í¬ ì²˜ë¦¬
      if (text.href) {
        formattedText = `<a href="${text.href}" target="_blank" rel="noopener noreferrer">${formattedText}</a>`;
      }

      return formattedText;
    })
    .join('');
}


/**
 * ë¸”ë¡ì˜ ìì‹ë“¤ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ (ì£¼ë¡œ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë‚´ë¶€ ì²˜ë¦¬ìš©)
 */
async function renderChildren(block: BlockObjectResponse): Promise<string> {
    // getPageBlocksì—ì„œ ì´ë¯¸ childrenì„ ì±„ì› ìœ¼ë¯€ë¡œ ì§ì ‘ ì‚¬ìš©
    const children = (block as any).children as BlockObjectResponse[] | undefined;

    if (!children || children.length === 0) {
      // console.debug(`ë Œë”ë§í•  ìì‹ ì—†ìŒ: Block ID ${block.id}`);
      return '';
    }

    console.log(`ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¸”ë¡ ${block.id} (${block.type})ì˜ ìì‹ ${children.length}ê°œ ë Œë”ë§ ì‹œì‘...`);
    // processBlocksë¥¼ ì¬ê·€ì ìœ¼ë¡œ í˜¸ì¶œí•˜ì—¬ ìì‹ ë¸”ë¡ë“¤ì˜ HTMLì„ ìƒì„±
    const childrenHtml = await processBlocks(children);
    console.log(`ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¸”ë¡ ${block.id} (${block.type})ì˜ ìì‹ ë Œë”ë§ ì™„ë£Œ (HTML ê¸¸ì´: ${childrenHtml.length})`);
    return childrenHtml;
}


/**
 * HTML ë¬¸ìì—´ ì •ë¦¬ í•¨ìˆ˜
 */
function cleanHtml(html: string): string {
  if (!html) return '';
  let cleaned = html;

  // ë¶ˆí•„ìš”í•œ ì¤‘ì²©/ë‹«ëŠ” íƒœê·¸ ì œê±° (ë” ì•ˆì „í•œ íŒ¨í„´ ì‚¬ìš©)
  // ì˜ˆ: <figure>...</figure></div> -> <figure>...</figure>
  cleaned = cleaned.replace(/(<figure[^>]*>[\s\S]*?<\/figure>)\s*<\/div>/gi, '$1');
  
  // HTML ì—”í‹°í‹° ë³µì› - &lt;figure&gt; ê°™ì€ í˜•íƒœë¥¼ <figure>ë¡œ ë³€í™˜
  cleaned = cleaned.replace(/&lt;(\/?figure)&gt;/gi, '<$1>');
  cleaned = cleaned.replace(/&lt;(\/?img)&gt;/gi, '<$1>');
  cleaned = cleaned.replace(/&lt;(\/?figcaption)&gt;/gi, '<$1>');
  
  // ì¤‘ë³µëœ ë‹«ëŠ” íƒœê·¸ ì œê±°
  cleaned = cleaned.replace(/<\/figure>\s*<\/figure>/gi, '</figure>');
  
  // ì—°ì† ê³µë°± ë° ì¤„ë°”ê¿ˆ ì •ë¦¬
  cleaned = cleaned.replace(/\s{2,}/g, ' '); // ì—°ì† ê³µë°± -> ë‹¨ì¼ ê³µë°±
  cleaned = cleaned.replace(/\n\s*\n/g, '\n'); // ì—°ì† ì¤„ë°”ê¿ˆ -> ë‹¨ì¼ ì¤„ë°”ê¿ˆ

  return cleaned.trim();
}

/**
 * ë¸”ë¡ ë°°ì—´ì„ HTML ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
 */
async function processBlocks(blocks: BlockObjectResponse[]): Promise<string> {
  let htmlChunks: string[] = [];
  if (!blocks || blocks.length === 0) return '';

  console.log(`ğŸ§± processBlocks: ${blocks.length}ê°œ ë¸”ë¡ ì²˜ë¦¬ ì‹œì‘`);

  let currentListType: 'ul' | 'ol' | null = null;

  for (let i = 0; i < blocks.length; i++) {
    const block = blocks[i];
    if (!block || !block.type) {
      console.warn(`âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ë¸”ë¡ ë°œê²¬ (index ${i}), ê±´ë„ˆëœë‹ˆë‹¤.`);
      continue;
    }

    const blockType = block.type;
    const isListItem = blockType === 'bulleted_list_item' || blockType === 'numbered_list_item';
    const listType = blockType === 'bulleted_list_item' ? 'ul' : 'ol';

    // ë¦¬ìŠ¤íŠ¸ ì‹œì‘/ì¢…ë£Œ ì²˜ë¦¬
    if (isListItem && currentListType !== listType) {
        // ì´ì „ ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
        if (currentListType) htmlChunks.push(`</${currentListType}>`);
        // ìƒˆ ë¦¬ìŠ¤íŠ¸ ì‹œì‘ - ë“¤ì—¬ì“°ê¸° ì—†ì´ í”Œë«í•˜ê²Œ ìƒì„±
        const listClass = listType === 'ul' ? 'list-disc' : 'list-decimal';
        htmlChunks.push(`<${listType} class="notion-list ${listClass} ml-6 my-2 flat-list">`);
        currentListType = listType;
    } else if (!isListItem && currentListType) {
        // ë¦¬ìŠ¤íŠ¸ ì¢…ë£Œ
        htmlChunks.push(`</${currentListType}>`);
        currentListType = null;
    }

    // ê°œë³„ ë¸”ë¡ ë Œë”ë§
    try {
        const { renderedHtml } = await renderBlock(block);
        htmlChunks.push(renderedHtml);
    } catch (renderError) {
       console.error(`ğŸ”´ ë¸”ë¡ ${block.id} (${block.type}) ë Œë”ë§ ì˜¤ë¥˜:`, renderError);
       htmlChunks.push(`<div class="notion-error p-4 my-4 bg-red-50 text-red-500 rounded">ë¸”ë¡ ${block.type} ë Œë”ë§ ì˜¤ë¥˜</div>`);
    }
  }

  // ë§ˆì§€ë§‰ ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
  if (currentListType) {
    htmlChunks.push(`</${currentListType}>`);
  }

  const rawHtml = htmlChunks.join('');
  console.log(`ğŸ§± processBlocks ì™„ë£Œ: ì´ ${blocks.length}ê°œ ë¸”ë¡ ì²˜ë¦¬ë¨, Raw HTML ê¸¸ì´: ${rawHtml.length}`);

  // HTML ì •ë¦¬
  const cleanedHtml = cleanHtml(rawHtml);
  // console.log(`âœ¨ HTML ì •ë¦¬ ì™„ë£Œ: ì •ë¦¬ í›„ HTML ê¸¸ì´: ${cleanedHtml.length}`);

  return cleanedHtml;
}


/**
 * ë‹¨ì¼ ë…¸ì…˜ ë¸”ë¡ì„ HTMLë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
 * (í•˜ìœ„ ë¸”ë¡ ë Œë”ë§ í¬í•¨)
 */
async function renderBlock(block: BlockObjectResponse): Promise<{ renderedHtml: string, imageUrl: string | null }> {
    let renderedHtml = '';
    let imageUrl: string | null = null;
    const blockType = block.type;

    // ìì‹ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ populate ë˜ì–´ ìˆìŒ)
    const children = (block as any).children as BlockObjectResponse[] | undefined;
    let childrenHtml = '';
    if (children && children.length > 0) {
         // console.debug(`ë Œë”ë§ ë¸”ë¡ ${block.id} (${block.type})ì˜ ìì‹ ${children.length}ê°œ`);
         childrenHtml = await processBlocks(children); // ìì‹ë“¤ë„ ë™ì¼í•œ í”„ë¡œì„¸ìŠ¤ë¡œ ì²˜ë¦¬
    }

    switch (blockType) {
        case 'paragraph':
            renderedHtml = `<p class="notion-paragraph my-2">${renderRichText((block as any).paragraph.rich_text)}</p>`;
            break;
        case 'heading_1':
            renderedHtml = `<h1 class="notion-h1 text-3xl font-bold my-4">${renderRichText((block as any).heading_1.rich_text)}</h1>`;
            break;
        case 'heading_2':
            renderedHtml = `<h2 class="notion-h2 text-2xl font-bold my-3">${renderRichText((block as any).heading_2.rich_text)}</h2>`;
            break;
        case 'heading_3':
            renderedHtml = `<h3 class="notion-h3 text-xl font-bold my-2">${renderRichText((block as any).heading_3.rich_text)}</h3>`;
            break;
        case 'bulleted_list_item':
        case 'numbered_list_item':
            const listItemContent = renderRichText((block as any)[blockType].rich_text);
            // ìì‹ HTMLì„ ë³„ë„ì˜ divë¡œ ê°ì‹¸ì§€ ì•Šê³  ì§ì ‘ í¬í•¨ì‹œì¼œ ë“¤ì—¬ì“°ê¸° ë°©ì§€
            renderedHtml = `<li class="notion-list-item">${listItemContent}${childrenHtml ? childrenHtml : ''}</li>`;
            break;
        case 'quote':
            renderedHtml = `<blockquote class="notion-quote border-l-4 border-gray-300 pl-4 italic my-4">${renderRichText((block as any).quote.rich_text)}${childrenHtml ? childrenHtml : ''}</blockquote>`;
            break;
        case 'code':
            const codeContent = renderRichText((block as any).code.rich_text);
            const language = (block as any).code.language || 'plaintext';
            // Prism.js ë“±ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
            renderedHtml = `<pre class="notion-code my-4 p-4 bg-gray-100 rounded overflow-x-auto"><code class="language-${language}">${codeContent}</code></pre>`;
            break;
        case 'image':
            const img = (block as any).image;
            let src = '';
            
            // ì´ë¯¸ì§€ ì†ŒìŠ¤ ì²˜ë¦¬ ê°œì„ 
            if (img?.file?.url) {
                src = img.file.url;
            } else if (img?.external?.url) {
                src = img.external.url;
            }
            
            imageUrl = src;
            const caption = renderRichText(img?.caption) || '';
            
            if (src) {
                // ì´ë¯¸ì§€ HTML ìƒì„± - ì—¬ëŸ¬ ì¤„ì˜ í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ëŒ€ì‹  í•œ ì¤„ë¡œ í‘œí˜„í•˜ì—¬ HTML íŒŒì‹± ë¬¸ì œ ë°©ì§€
                renderedHtml = `<figure class="notion-image my-8 text-center"><img src="${escapeHTML(src)}" alt="${caption || 'Notion image'}" class="max-w-full h-auto inline-block" loading="lazy" onerror="this.onerror=null; console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', this.src);">${caption ? `<figcaption class="text-sm text-gray-500 mt-2">${caption}</figcaption>` : ''}</figure>`;
            } else {
                console.error(`ì´ë¯¸ì§€ ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ (Block ID: ${block.id}):`, img);
                renderedHtml = `<div class="notion-error p-4 my-4 bg-red-50 text-red-500 rounded">ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜ (ì†ŒìŠ¤ ì—†ìŒ)</div>`;
            }
            break;
        case 'video':
             const video = (block as any).video;
             const videoSrc = video?.file?.url ?? video?.external?.url;
             if (videoSrc) {
                 // ë¹„ë””ì˜¤ HTMLë„ í•œ ì¤„ë¡œ í‘œí˜„
                 renderedHtml = `<div class="notion-video my-8"><video controls class="w-full" src="${escapeHTML(videoSrc)}" loading="lazy"></video>${renderRichText(video?.caption) ? `<p class="text-sm text-gray-500 mt-2">${renderRichText(video.caption)}</p>` : ''}</div>`;
             } else {
                 renderedHtml = `<div class="notion-error p-4 my-4 bg-red-50 text-red-500 rounded">ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜</div>`;
             }
             break;
        case 'divider':
            renderedHtml = `<hr class="notion-divider my-8">`;
            break;
        case 'callout':
             const callout = (block as any).callout;
             const icon = callout.icon?.type === 'emoji' ? callout.icon.emoji : 'ğŸ’¡';
             // ì½œì•„ì›ƒë„ í•œ ì¤„ë¡œ ì •ë¦¬
             renderedHtml = `<div class="notion-callout bg-gray-100 p-4 my-4 rounded flex items-start"><span class="mr-2">${icon}</span><div>${renderRichText(callout.rich_text)}${childrenHtml ? `<div class="mt-2">${childrenHtml}</div>` : ''}</div></div>`;
             break;
        case 'bookmark':
             const bookmark = (block as any).bookmark;
             renderedHtml = `
                 <div class="notion-bookmark my-4 border p-4 rounded block hover:bg-gray-50" >
                     <a href="${escapeHTML(bookmark.url)}" target="_blank" rel="noopener noreferrer">
                         <p class="font-semibold truncate">${renderRichText(bookmark.caption) || escapeHTML(bookmark.url)}</p>
                         <p class="text-sm text-gray-500 truncate">${escapeHTML(bookmark.url)}</p>
                     </a>
                 </div>`;
             break;
        case 'table':
            // í…Œì´ë¸” ë Œë”ë§: childrenHtmlì´ table rowsë¥¼ í¬í•¨í•´ì•¼ í•¨
            renderedHtml = `<div class="notion-table-wrapper overflow-x-auto my-4"><table class="notion-table w-full border-collapse border border-gray-300">${childrenHtml}</table></div>`;
            break;
        case 'table_row':
             const cells = (block as any).table_row.cells;
             renderedHtml = `<tr class="notion-table-row">${cells.map((cell: RichTextItemResponse[]) => `<td class="border border-gray-300 p-2">${renderRichText(cell)}</td>`).join('')}</tr>\n`;
            break;
         case 'toggle':
             renderedHtml = `
                 <details class="notion-toggle my-2">
                     <summary class="cursor-pointer font-medium">${renderRichText((block as any).toggle.rich_text)}</summary>
                     <div class="pl-4 mt-1">
                         ${childrenHtml || '<p class="text-gray-500">ë‚´ìš© ì—†ìŒ</p>'}
                     </div>
                 </details>`;
             break;
        case 'child_page':
             renderedHtml = `<div class="notion-child-page my-2 p-2 border rounded bg-gray-50">ğŸ“„ ${escapeHTML((block as any).child_page.title)}</div>`;
             break;
        case 'child_database':
             renderedHtml = `<div class="notion-child-database my-4 p-2 border rounded bg-gray-50">ğŸ’¾ ${escapeHTML((block as any).child_database.title)}</div>`;
             break;
        case 'embed':
             const embed = (block as any).embed;
             renderedHtml = `
                 <figure class="notion-embed my-8">
                    <iframe src="${escapeHTML(embed.url)}" class="w-full h-96 border-0" allowfullscreen loading="lazy"></iframe>
                    ${renderRichText(embed.caption) ? `<figcaption class="text-sm text-gray-500 mt-2">${renderRichText(embed.caption)}</figcaption>`: ''}
                 </figure>`;
             break;
        case 'equation':
             // KaTeX/MathJax ë Œë”ë§ í•„ìš”
             renderedHtml = `<div class="notion-equation my-2 text-center" data-equation="${escapeHTML((block as any).equation.expression)}">[Equation: ${escapeHTML((block as any).equation.expression)}]</div>`;
             break;
        case 'file':
             const file = (block as any).file;
             const fileUrl = file.file?.url ?? file.external?.url;
             const fileName = renderRichText(file.caption) || file.name || 'Download File';
             renderedHtml = `
                 <div class="notion-file my-4 p-2 border rounded flex items-center">
                     <span class="mr-2">ğŸ“</span>
                     <a href="${escapeHTML(fileUrl)}" target="_blank" rel="noopener noreferrer" class="hover:underline">${escapeHTML(fileName)}</a>
                 </div>`;
             break;
         case 'synced_block':
              // ì›ë³¸ ë¸”ë¡ì„ ê°€ì ¸ì˜¤ê±°ë‚˜, childrenHtmlì„ ì§ì ‘ ì‚¬ìš© (í˜„ì¬ëŠ” childrenHtml ì‚¬ìš©)
              console.warn("Synced block encountered - rendering contained blocks directly.");
              renderedHtml = childrenHtml;
              break;
        // ë¯¸ì§€ì› ë¸”ë¡ íƒ€ì… ì²˜ë¦¬
        case 'unsupported':
             console.warn(`Unsupported block type encountered: ${block.id}`);
             renderedHtml = `<p class="notion-error notion-unsupported">[ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡ íƒ€ì…]</p>`;
             break;
        default:
            console.warn(`Unhandled block type: ${blockType} (ID: ${block.id})`);
            // ê¸°ë³¸ì ìœ¼ë¡œ plain_textê°€ ìˆìœ¼ë©´ í‘œì‹œ ì‹œë„
            const richText = (block as any)[blockType]?.rich_text;
            if (richText) {
                 renderedHtml = `<div class="notion-unknown-${blockType}">${renderRichText(richText)}</div>`;
            } else {
                 renderedHtml = `<div class="notion-error p-4 my-4 bg-red-50 text-red-500 rounded">ì•Œ ìˆ˜ ì—†ëŠ” ë¸”ë¡: ${blockType}</div>`;
            }
    }

    return { renderedHtml, imageUrl };
}

/**
 * ì´ë¯¸ì§€ ë¸”ë¡ ë Œë”ë§ (í˜„ì¬ renderBlock ë‚´ë¶€ ë¡œì§ìœ¼ë¡œ í†µí•©ë¨)
 */
// function renderImage(block: any): string { ... } 