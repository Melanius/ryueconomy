import { Client } from '@notionhq/client';
import { NotionToMarkdown } from 'notion-to-md';
import { cache } from 'react';
import { 
  PageObjectResponse, 
  RichTextItemResponse,
  SelectPropertyItemObjectResponse,
  DatePropertyItemObjectResponse,
  NumberPropertyItemObjectResponse,
  TitlePropertyItemObjectResponse,
  BlockObjectResponse, 
  PartialBlockObjectResponse
} from '@notionhq/client/build/src/api-endpoints';
import { Post } from '@/types/post';
import { CategoryId, NotionPage } from '@/types/notion';
import { notion, databaseId } from './notionClient';
import { notionLog } from './logger';
// ìºì‹œ ë ˆì´ì–´ import ì¶”ê°€
import { 
  getAllPosts as getCachedPosts,
  getPostBySlug as getCachedPostBySlug,
  getRelatedPosts as getCachedRelatedPosts,
  getCachedBlocks,
  getCachedPageContentAndThumbnail
} from './cache/notion-cache';

// ë…¸ì…˜ í˜ì´ì§€ ì†ì„± íƒ€ì… ì •ì˜
interface NotionPageProperties {
  Title: any;
  Excerpt: any;
  Category: any;
  Date: any;
  Views: any;
  Slug: any;
  Featured?: any;
}

// BlogPostëŠ” Postì˜ í™•ì¥ìœ¼ë¡œ ì •ì˜
interface BlogPost extends Post {
  excerpt: string;
  slug: string;
  image: string;
  featured: boolean;
}

/**
 * ë…¸ì…˜ ì¹´í…Œê³ ë¦¬ë¥¼ ë¸”ë¡œê·¸ ì¹´í…Œê³ ë¦¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
 */
function mapNotionCategory(notionCategory: string): CategoryId {
  notionLog.info(`Mapping Notion category: ${notionCategory}`);
  
  switch (notionCategory.toLowerCase()) {
    case 'portfolio':
    case 'project':
    case 'work':
    case 'showcase':
    case 'real-portfolio':
      return 'real-portfolio';
      
    case 'code-lab':
    case 'tutorial':
    case 'guide':
    case 'how-to':
    case 'development':
      return 'code-lab';
      
    case 'daily':
    case 'daily-log':
    case 'log':
    case 'diary':
    case 'journal':
      return 'daily-log';
      
    case 'crypto':
    case 'crypto-morning':
    case 'cryptocurrency':
    case 'market':
    case 'trading':
      return 'crypto-morning';
      
    default:
      notionLog.info(`No direct mapping found for category: ${notionCategory}, using default`);
      return 'invest-insight';
  }
}

/**
 * ë…¸ì…˜ í˜ì´ì§€ ê°ì²´ë¥¼ Post ì¸í„°í˜ì´ìŠ¤ë¡œ ë³€í™˜
 */
export function pageToPost(page: PageObjectResponse): BlogPost {
  try {
    notionLog.info(`ğŸ“˜ í˜ì´ì§€ ë³€í™˜ ì‹œì‘: ID ${page.id.substring(0, 8)}...`);
    
    // í˜ì´ì§€ ì†ì„±ì„ ì½˜ì†”ì— ì¶œë ¥ (ë””ë²„ê¹…)
    notionLog.info(`ğŸ“˜ í˜ì´ì§€ ì†ì„± ëª©ë¡:`, Object.keys(page.properties).map(key => ({
      key,
      type: (page.properties as any)[key].type
    })));
    
    // ì—¬ê¸°ì„œ Notion í˜ì´ì§€ì˜ í”„ë¡œí¼í‹°ë¥¼ í™•ì¸í•˜ì—¬ í•„ìš”í•œ ë°ì´í„°ë¥¼ ì¶”ì¶œ
    const titleProperty = page.properties.title || page.properties.Title || page.properties.Name;
    let title = 'Untitled';
    
    if (titleProperty?.type === 'title' && titleProperty.title.length > 0) {
      title = titleProperty.title.map(t => t.plain_text).join("").trim();
      // ì œëª©ì´ ë¹ˆ ë¬¸ìì—´ì¸ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
      if (title === '') {
        title = `Untitled-${page.id.substring(0, 6)}`;
        notionLog.info(`ğŸ“˜ ë¹ˆ ì œëª© ë°œê²¬: ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒ€ì²´ "${title}"`);
      }
    } else {
      title = `Untitled-${page.id.substring(0, 6)}`;
      notionLog.info(`ğŸ“˜ ì œëª© ì†ì„± ì—†ìŒ: ê¸°ë³¸ê°’ ì‚¬ìš© "${title}"`);
    }
    
    const slugProperty = page.properties.slug || page.properties.Slug;
    let slug = '';
    
    if (slugProperty?.type === 'rich_text' && slugProperty.rich_text.length > 0) {
      slug = slugProperty.rich_text.map(t => t.plain_text).join("").trim();
    }
    
    // ìŠ¬ëŸ¬ê·¸ê°€ ì—†ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´ì¸ ê²½ìš° ì œëª©ì—ì„œ ìƒì„±
    if (!slug) {
      slug = title
        .toLowerCase()
        .replace(/[^\w\s-]/g, '') // íŠ¹ìˆ˜ë¬¸ì ì œê±°
        .replace(/\s+/g, '-')     // ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ ë³€ê²½
        .replace(/-+/g, '-');     // ì¤‘ë³µ í•˜ì´í”ˆ ì œê±°
      
      // ìŠ¬ëŸ¬ê·¸ê°€ ì—¬ì „íˆ ë¹„ì–´ìˆë‹¤ë©´ ID ì‚¬ìš©
      if (!slug || slug === '-') {
        slug = `post-${page.id.substring(0, 8)}`;
      }
      
      notionLog.info(`ğŸ“˜ ìŠ¬ëŸ¬ê·¸ ìë™ ìƒì„±: "${title}" â†’ "${slug}"`);
    }
    
    const excerptProperty = page.properties.excerpt || page.properties.Excerpt;
    const excerpt = excerptProperty?.type === 'rich_text' && excerptProperty.rich_text.length > 0
      ? excerptProperty.rich_text.map(t => t.plain_text).join("") 
      : ""; // ë°œì·Œë¬¸ì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ì‚¬ìš© (ê¸°ì¡´ì—ëŠ” ì œëª©ì„ ì‚¬ìš©í–ˆìŒ)
    
    const categoryProperty = page.properties.category || page.properties.Category;
    let notionCategory = 'Uncategorized';
    
    if (categoryProperty?.type === 'select' && categoryProperty.select?.name) {
      notionCategory = categoryProperty.select.name;
    }
    
    // ë…¸ì…˜ ì¹´í…Œê³ ë¦¬ë¥¼ ë¸”ë¡œê·¸ ì¹´í…Œê³ ë¦¬ë¡œ ë§¤í•‘
    const category = mapNotionCategory(notionCategory);
    
    const dateProperty = page.properties.date || page.properties.Date || page.properties.Published || page.properties['ìƒì„± ì¼ì‹œ'] || page.properties.Created;
    let date = new Date().toISOString().split('T')[0]; // ê¸°ë³¸ê°’ì€ ì˜¤ëŠ˜ ë‚ ì§œ
    
    if (dateProperty?.type === 'date' && dateProperty.date?.start) {
      date = dateProperty.date.start;
    } else if (page.created_time) {
      // ë‚ ì§œ ì†ì„±ì´ ì—†ìœ¼ë©´ ìƒì„±ì¼ ì‚¬ìš©
      date = new Date(page.created_time).toISOString().split('T')[0];
      notionLog.info(`ğŸ“˜ ë‚ ì§œ ì†ì„± ì—†ìŒ, ìƒì„±ì¼ ì‚¬ìš©: ${date}`);
    }
    
    // Views ì†ì„± ì²˜ë¦¬ ê°œì„  (ë””ë²„ê¹…)
    const viewsProperty = page.properties.views || page.properties.Views;
    notionLog.info(`ğŸ“˜ ì¡°íšŒìˆ˜ ì†ì„± ì²˜ë¦¬:`, viewsProperty ? JSON.stringify(viewsProperty) : 'undefined');
    
    let views = 0;
    if (viewsProperty) {
      if (viewsProperty.type === 'number') {
        views = viewsProperty.number !== null ? viewsProperty.number : 0;
        notionLog.info(`ğŸ“˜ ì¡°íšŒìˆ˜ ì¶”ì¶œ ì„±ê³µ: ${views}`);
      } else {
        notionLog.info(`ğŸ“˜ ì¡°íšŒìˆ˜ ì†ì„±ì´ number íƒ€ì…ì´ ì•„ë‹˜: ${viewsProperty.type}`);
      }
    } else {
      notionLog.info(`ğŸ“˜ ì¡°íšŒìˆ˜ ì†ì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
    }
    
    const featuredProperty = page.properties.featured || page.properties.Featured;
    const featured = featuredProperty?.type === 'checkbox' 
      ? featuredProperty.checkbox || false 
      : false;
    
    // ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL ì²´í¬ (ë…¸ì…˜ í˜ì´ì§€ ì»¤ë²„ ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°)
    let image = '';
    
    // í˜ì´ì§€ ì»¤ë²„ ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°
    if (page.cover) {
      if (page.cover.type === 'external') {
        image = page.cover.external.url;
      } else if (page.cover.type === 'file') {
        image = page.cover.file.url;
      }
    }
    
    // ì´ë¯¸ì§€ ì†ì„±ì´ ì§ì ‘ ìˆëŠ” ê²½ìš°
    const imageProperty = page.properties.image || page.properties.Image || page.properties.Cover || page.properties.Thumbnail;
    if (!image && imageProperty?.type === 'url') {
      image = imageProperty.url || '';
    } else if (!image && imageProperty?.type === 'files' && imageProperty.files.length > 0) {
      const file = imageProperty.files[0];
      if (file.type === 'external') {
        image = file.external.url;
      } else if (file.type === 'file') {
        image = file.file.url;
      }
    }
    
    notionLog.info(`ğŸ“˜ í¬ìŠ¤íŠ¸ ë³€í™˜ ì™„ë£Œ: "${title}" (${category}), ì¡°íšŒìˆ˜: ${views}, ì´ë¯¸ì§€: ${image ? 'ìˆìŒ' : 'ì—†ìŒ'}`);
    
    return {
      id: page.id,
      title,
      slug,
      excerpt,
      category,
      date,
      views,
      featured,
      image, // ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL ì¶”ê°€
      content: "", // ì»¨í…ì¸ ëŠ” ë³„ë„ë¡œ ê°€ì ¸ì™€ì•¼ í•¨
      author: { name: "Ryue" }, // ê¸°ë³¸ ì‘ì„±ì ì •ë³´ ì„¤ì •
      tags: [], // ê¸°ë³¸ ë¹ˆ íƒœê·¸ ë°°ì—´ ì„¤ì •
    };
  } catch (error) {
    notionLog.error("Error converting page to post:", error);
    notionLog.error("Problem page ID:", page.id);
    
    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ í¬ìŠ¤íŠ¸ ê°ì²´ ë°˜í™˜
    return {
      id: page.id,
      title: "ì˜¤ë¥˜ ë°œìƒí•œ ê²Œì‹œë¬¼",
      slug: page.id,
      excerpt: "ì´ ê²Œì‹œë¬¼ì„ ë³€í™˜í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
      category: "daily-log" as CategoryId,
      date: new Date().toISOString().split('T')[0],
      views: 0,
      featured: false,
      content: "",
      author: { name: "Ryue" }, // ê¸°ë³¸ ì‘ì„±ì ì •ë³´ ì„¤ì •
      tags: [], // ê¸°ë³¸ ë¹ˆ íƒœê·¸ ë°°ì—´ ì„¤ì •
      image: "", // ì´ë¯¸ì§€ ì†ì„± ì¶”ê°€
    };
  }
}

// ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì†ì„± íƒ€ì… ì •ì˜
interface NotionPostProperties {
  Title: TitlePropertyItemObjectResponse;
  Excerpt: { rich_text: RichTextItemResponse[] };
  Category: SelectPropertyItemObjectResponse;
  Date: DatePropertyItemObjectResponse;
  Views: NumberPropertyItemObjectResponse;
  Slug: { rich_text: RichTextItemResponse[] };
  Published: { checkbox: boolean };
}

/**
 * Notion APIì™€ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ìœ íš¨ì„± ê²€ì‚¬
 * ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ í˜¸ì¶œë˜ì–´ Notion ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
 * @returns Promise<boolean> ì„¤ì • ìœ íš¨ì„± ì—¬ë¶€
 */
export async function validateNotionConfig(): Promise<boolean> {
  notionLog.info('ğŸ“˜ Notion ì„¤ì • ê²€ì¦ ì‹œì‘...');
  try {
    const notionApiKey = process.env.NOTION_TOKEN;
    const notionDatabaseId = process.env.NOTION_DATABASE_ID;

    const configResult = {
      NOTION_TOKEN: {
        exists: !!notionApiKey,
        valid: notionApiKey && notionApiKey.length > 20,
        masked: notionApiKey ? `${notionApiKey.substring(0, 4)}...${notionApiKey.substring(notionApiKey.length - 4)}` : 'undefined'
      },
      NOTION_DATABASE_ID: {
        exists: !!notionDatabaseId,
        valid: notionDatabaseId && notionDatabaseId.length > 10,
        masked: notionDatabaseId || 'undefined'
      }
    };

    // ì„¤ì • ìœ íš¨ì„± ê²€ì‚¬
    if (!configResult.NOTION_TOKEN.exists || !configResult.NOTION_TOKEN.valid) {
      throw new Error('Notion API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    if (!configResult.NOTION_DATABASE_ID.exists || !configResult.NOTION_DATABASE_ID.valid) {
      throw new Error('Notion Database IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    notionLog.info('âœ… Notion ì„¤ì •ì´ ìœ íš¨í•©ë‹ˆë‹¤:', {
      apiKey: configResult.NOTION_TOKEN.masked,
      databaseId: configResult.NOTION_DATABASE_ID.masked
    });

    return true;
  } catch (error) {
    notionLog.error('âŒ Notion ì„¤ì • ê²€ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    return false;
  }
}

/**
 * Notion APIì— í…ŒìŠ¤íŠ¸ ì—°ê²°ì„ ì‹œë„í•˜ì—¬ API í‚¤ì™€ ê¶Œí•œì´ ìœ íš¨í•œì§€ í™•ì¸
 */
async function testNotionConnection() {
  try {
    notionLog.info('ğŸ“˜ Notion API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
    
    const notionToken = process.env.NOTION_TOKEN;
    const databaseId = process.env.NOTION_DATABASE_ID;
    
    if (!notionToken || !databaseId) {
      notionLog.error('âŒ API í‚¤ ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ IDê°€ ì—†ì–´ API ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
      return false;
    }
    
    // ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ ì¡°íšŒ í…ŒìŠ¤íŠ¸
    const database = await notion.databases.retrieve({
      database_id: databaseId
    });
    
    // ë°ì´í„°ë² ì´ìŠ¤ ì œëª© ì ‘ê·¼ ë°©ì‹ ìˆ˜ì •
    let databaseTitle = 'Untitled';
    try {
      // @ts-ignore - Notion API íƒ€ì…ê³¼ì˜ í˜¸í™˜ì„± ë¬¸ì œ
      if (database.title && database.title.length > 0) {
        // @ts-ignore
        databaseTitle = database.title[0].plain_text || 'Untitled';
      }
    } catch (e) {
      // íƒ€ì… ì˜¤ë¥˜ ë¬´ì‹œ
    }
    
    notionLog.info(`âœ… Notion API ì—°ê²° ì„±ê³µ. ë°ì´í„°ë² ì´ìŠ¤ "${databaseTitle}" ì ‘ê·¼ ê°€ëŠ¥`);
    
    return true;
  } catch (error) {
    notionLog.error('âŒ Notion API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error instanceof Error ? error.message : error);
    notionLog.error('âŒ API í‚¤ì™€ ë°ì´í„°ë² ì´ìŠ¤ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
    return false;
  }
}

// Notion to Markdown ë³€í™˜ê¸° ì´ˆê¸°í™”
export const n2m = new NotionToMarkdown({ 
  notionClient: notion
});

// ë¸”ë¡ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
export async function getBlocks(blockId: string): Promise<(BlockObjectResponse | PartialBlockObjectResponse)[]> {
  try {
    notionLog.info(`ğŸ“˜ ìºì‹œ ë ˆì´ì–´ë¥¼ í†µí•´ ë¸”ë¡ ID "${blockId.substring(0, 8)}..."ì˜ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œì‘...`);
    return await getCachedBlocks(blockId);
  } catch (error) {
    notionLog.error("Error fetching blocks:", error);
    return [];
  }
}

// ë¸”ë¡ì„ HTML ì»¨í…ì¸ ë¡œ ë³€í™˜
function blocksToHtml(blocks: (BlockObjectResponse | PartialBlockObjectResponse)[]): string {
  return blocks.map(block => {
    const { type } = block as BlockObjectResponse;
    
    if (!type) return '';
    
    // íƒ€ì… ë‹¨ì–¸ì„ í†µí•´ ì•ˆì „í•˜ê²Œ ì ‘ê·¼
    const blockWithType = block as any;
    const text = blockWithType[type]?.rich_text?.[0]?.plain_text || '';
    
    switch (type) {
      case 'paragraph':
        return text ? `<p>${text}</p>` : '<p></p>';
      case 'heading_1':
        return `<h1>${text}</h1>`;
      case 'heading_2':
        return `<h2>${text}</h2>`;
      case 'heading_3':
        return `<h3>${text}</h3>`;
      case 'bulleted_list_item':
        return `<li>${text}</li>`;
      case 'numbered_list_item':
        return `<li>${text}</li>`;
      case 'code':
        return `<pre><code>${text}</code></pre>`;
      case 'quote':
        return `<blockquote>${text}</blockquote>`;
      case 'divider':
        return '<hr/>';
      default:
        return '';
    }
  }).join('');
}

// ë¸”ë¡ë“¤ì„ HTMLë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
async function renderBlocks(blocks: BlockObjectResponse[]): Promise<{ html: string }> {
  try {
    notionLog.info(`ğŸ“˜ ë Œë”ë§ ì‹œì‘: ${blocks.length}ê°œ ë¸”ë¡ ì²˜ë¦¬ ì¤‘...`);
    
    // ë¸”ë¡ íƒ€ì…ë³„ ì¹´ìš´íŠ¸ (ë””ë²„ê¹…ìš©)
    const blockTypeCount: Record<string, number> = {};
    const countBlockTypes = (blocks: any[]) => {
      blocks.forEach(block => {
        if (block.type) {
          blockTypeCount[block.type] = (blockTypeCount[block.type] || 0) + 1;
        }
        // ì¤‘ì²©ëœ ë¸”ë¡ë„ ì¹´ìš´íŠ¸
        if (block.children && block.children.length > 0) {
          countBlockTypes(block.children);
        }
      });
    };
    
    countBlockTypes(blocks);
    notionLog.info('ğŸ“˜ ë¸”ë¡ íƒ€ì… í†µê³„:', blockTypeCount);
    
    // processBlocks ì‹¤í–‰ ì „ ë¡œê¹…
    notionLog.info('ğŸ“˜ processBlocks í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘');
    const processStartTime = Date.now();
    
    const html = await processBlocks(blocks);
    
    const processEndTime = Date.now();
    notionLog.info(`ğŸ“˜ processBlocks ì™„ë£Œ: ì†Œìš” ì‹œê°„ ${(processEndTime - processStartTime) / 1000}ì´ˆ`);
    notionLog.info(`ğŸ“˜ ë Œë”ë§ ì™„ë£Œ: HTML ìƒì„±ë¨ (ê¸¸ì´: ${html.length})`);
    
    // HTMLì´ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
    if (html.trim() === '') {
      notionLog.warn('âš ï¸ ìƒì„±ëœ HTMLì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë””ë²„ê¹… í•„ìš”');
    }
    
    return { html };
  } catch (error) {
    notionLog.error('ğŸ”´ renderBlocks ì˜¤ë¥˜:', error);
    return { html: '<div class="notion-error">ì»¨í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>' };
  }
}

/**
 * í˜ì´ì§€ ì»¨í…ì¸  ë° ì¸ë„¤ì¼ URL ê°€ì ¸ì˜¤ê¸°
 */
export async function getPageContentAndThumbnail(pageId: string): Promise<{ content: string, thumbnail: string, image: string }> {
  try {
    notionLog.info(`ğŸ“˜ ìºì‹œ ë ˆì´ì–´ë¥¼ í†µí•´ í˜ì´ì§€ ID "${pageId.substring(0, 8)}..."ì˜ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸° ì‹œì‘...`);
    return await getCachedPageContentAndThumbnail(pageId);
  } catch (error) {
    notionLog.error(`Error getting page content via cache layer:`, error);
    return { content: '', thumbnail: '', image: '' };
  }
}

// Add these helper functions before the renderRichText function
function escapeHTML(text: string): string {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function isEmoji(str: string): boolean {
  const regex = /[\p{Emoji_Presentation}\p{Extended_Pictographic}]/u;
  return regex.test(str);
}

// ì„œì‹ì´ ìˆëŠ” í…ìŠ¤íŠ¸ ë Œë”ë§ - ìƒ‰ìƒ ì •ë³´ í¬í•¨
export function renderRichText(richText: RichTextItemResponse | RichTextItemResponse[] | undefined | null): string {
  // undefined, null ì²´í¬
  if (!richText) {
    notionLog.debug('renderRichText: richTextê°€ undefined ë˜ëŠ” nullì…ë‹ˆë‹¤.');
    return "";
  }
  
  // ë‹¨ì¼ í•­ëª©ì¸ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
  let richTextArray: RichTextItemResponse[] = [];
  
  if (Array.isArray(richText)) {
    richTextArray = richText;
  } else {
    // ë‹¨ì¼ ê°ì²´ì¸ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
    richTextArray = [richText];
  }
  
  // ë¹ˆ ë°°ì—´ ì²´í¬
  if (richTextArray.length === 0) {
    notionLog.debug('renderRichText: ë³€í™˜í•  ë¦¬ì¹˜ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return "";
  }
  
  notionLog.debug(`Rendering ${richTextArray.length} rich text segments`);
  
  try {
    return richTextArray.map((item) => {
      if (!item) return ""; // í•­ëª©ì´ null ë˜ëŠ” undefinedì¸ ê²½ìš° ì²˜ë¦¬
      
      let content = "";
      
      // Handle different types of rich text items
      if (item.type === "equation") {
        content = item.equation.expression;
      } else if (item.type === "text") {
        content = item.text.content;
        
        // ì›ë³¸ ë‚´ìš© ë¡œê¹… (ë””ë²„ê¹…ìš©)
        if (content && (content.includes('\t') || content.match(/^ +/))) {
          notionLog.debug(`ë“¤ì—¬ì“°ê¸° ê°ì§€: "${content.replace(/\n/g, '\\n').substring(0, 30)}..."`);
        }
        
        // HTML escape ë¨¼ì € ìˆ˜í–‰ (emoji ì œì™¸)
        if (content && !isEmoji(content)) {
          content = escapeHTML(content);
        }
        
        // ëª¨ë“  ê³µë°± ì²˜ë¦¬ ê°œì„  (ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ ì •ê·œì‹ ìµœì†Œí™”)
        if (content) {
          // 1. íƒ­ì„ 4ê°œì˜ ê³µë°±ìœ¼ë¡œ ë³€í™˜
          content = content.replace(/\t/g, "    ");
          
          // 2. ì¤„ ì‹œì‘ ë¶€ë¶„ì˜ ê³µë°± ì²˜ë¦¬ (ë“¤ì—¬ì“°ê¸°) - ê° ì¤„ë§ˆë‹¤ ì ìš©
          content = content.replace(/^( +)/gm, (match) => {
            return "&nbsp;".repeat(match.length);
          });
          
          // 3. ì¤„ ì¤‘ê°„ì˜ ì—°ì†ëœ ê³µë°± ì²˜ë¦¬ (2ê°œ ì´ìƒ ì—°ì†ëœ ê³µë°±ë§Œ ë³€í™˜)
          content = content.replace(/( {2,})/g, (match) => {
            return " " + "&nbsp;".repeat(match.length - 1);
          });
          
          // 4. ì¤„ë°”ê¿ˆ ë³´ì¡´
          content = content.replace(/\n/g, "<br>");
        }
        
        // Handle annotations/styles
        const annotations = item.annotations;
        
        // Apply color styles - ê°œì„ ëœ ìƒ‰ìƒ ì²˜ë¦¬
        if (annotations.color && annotations.color !== "default") {
          const colorMap: Record<string, string> = {
            // ê¸°ë³¸ ìƒ‰ìƒ
            "blue": "#2196f3",
            "blue_background": "#e3f2fd",
            "brown": "#795548",
            "brown_background": "#efebe9",
            "gray": "#9e9e9e",
            "gray_background": "#f5f5f5",
            "green": "#4caf50",
            "green_background": "#e8f5e9",
            "orange": "#ff9800",
            "orange_background": "#fff3e0",
            "pink": "#e91e63",
            "pink_background": "#fce4ec",
            "purple": "#9c27b0",
            "purple_background": "#f3e5f5",
            "red": "#f44336",
            "red_background": "#ffebee",
            "yellow": "#ffeb3b",
            "yellow_background": "#fffde7",
            // ì¶”ê°€ ìƒ‰ìƒ
            "default": "inherit",
            "black": "#000000",
            "white": "#ffffff",
          };
          
          const color = annotations.color;
          // ìƒ‰ìƒì´ color_background í˜•ì‹ì¸ì§€ í™•ì¸
          if (color.endsWith("_background")) {
            const colorValue = colorMap[color] || color;
            content = `<span style="background-color: ${colorValue};">${content}</span>`;
          } else {
            const colorValue = colorMap[color] || color;
            content = `<span style="color: ${colorValue};">${content}</span>`;
          }
        }
        
        // Apply text styles
        if (annotations.bold) {
          content = `<strong>${content}</strong>`;
        }
        
        if (annotations.italic) {
          content = `<em>${content}</em>`;
        }
        
        if (annotations.strikethrough) {
          content = `<s>${content}</s>`;
        }
        
        if (annotations.underline) {
          content = `<u>${content}</u>`;
        }
        
        if (annotations.code) {
          content = `<code>${content}</code>`;
        }
        
        // Handle links
        if (item.href) {
          content = `<a href="${item.href}" target="_blank" rel="noopener noreferrer">${content}</a>`;
        }
      }
      
      return content;
    }).join("");
  } catch (error) {
    notionLog.error('ğŸ”´ renderRichText ì˜¤ë¥˜:', error);
    return "";
  }
}

// ë¸”ë¡ ìì‹ë“¤ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
async function renderChildren(block: BlockObjectResponse): Promise<string> {
  if (!block || !block.has_children) return '';

  try {
    const response = await notion.blocks.children.list({
      block_id: block.id,
      page_size: 100, // ë” ë§ì€ ìì‹ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°
    });

    const blocks = response.results as BlockObjectResponse[];
    notionLog.info(`ğŸ“˜ ë¸”ë¡ ${block.id}ì˜ ìì‹ ${blocks.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    
    // ìì‹ ë¸”ë¡ íƒ€ì… ë¡œê¹… (ë””ë²„ê¹…ìš©)
    if (blocks.length > 0) {
      notionLog.debug(`ìì‹ ë¸”ë¡ íƒ€ì…: ${blocks.map(b => b.type).join(', ')}`);
    }
    
    let renderedChildren = '';
    
    // í˜„ì¬ì˜ ë¦¬ìŠ¤íŠ¸ íƒ€ì…ì„ ì¶”ì 
    let currentListType: string | null = null;
    let currentIndentLevel = 0;
    
    for (let i = 0; i < blocks.length; i++) {
      const childBlock = blocks[i];
      
      if ('type' in childBlock) {
        const blockType = childBlock.type;
        
        // ë¸”ë¡ì— ìì‹ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì¬ê·€ì ìœ¼ë¡œ ì²˜ë¦¬
        const hasNestedChildren = 'has_children' in childBlock && childBlock.has_children;
        
        // renderBlockì´ BlockObjectResponseë¥¼ ë°›ë„ë¡ íƒ€ì…ìºìŠ¤íŒ…
        const renderedBlock = await renderBlock(childBlock as BlockObjectResponse);
        let renderedContent = renderedBlock.renderedHtml;
        
        // ë¸”ë¡ì— ìì‹ì´ ìˆìœ¼ë©´ ì¬ê·€ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ê²°ê³¼ë¥¼ ì¶”ê°€
        if (hasNestedChildren && !['toggle', 'callout'].includes(blockType)) {
          const nestedContent = await renderChildren(childBlock as BlockObjectResponse);
          
          // ìì‹ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ì ì ˆí•œ ìœ„ì¹˜ì— ì¶”ê°€
          if (nestedContent.trim()) {
            // ë¦¬ìŠ¤íŠ¸ í•­ëª©ì˜ ê²½ìš° li íƒœê·¸ ë‚´ë¶€ì— ì¶”ê°€
            if (blockType === 'bulleted_list_item' || blockType === 'numbered_list_item') {
              // li íƒœê·¸ ë‹«ê¸° ì „ì— ì¤‘ì²©ëœ ì½˜í…ì¸  ì¶”ê°€
              renderedContent = renderedContent.replace('</li>', `${nestedContent}</li>`);
            } else {
              // ë‹¤ë¥¸ ë¸”ë¡ íƒ€ì…ì€ ê·¸ëƒ¥ ë’¤ì— ì¶”ê°€
              renderedContent += nestedContent;
            }
          }
        }
        
        // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ê·¸ë£¹í™”
        if (blockType === 'bulleted_list_item' || blockType === 'numbered_list_item') {
          const listType = blockType === 'bulleted_list_item' ? 'ul' : 'ol';
          
          // ë¦¬ìŠ¤íŠ¸ íƒ€ì…ì´ ë°”ë€Œê±°ë‚˜ ì²˜ìŒ ì‹œì‘í•˜ëŠ” ê²½ìš°
          if (currentListType !== listType) {
            // ì´ì „ ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë‹«ê¸°
            if (currentListType) {
              renderedChildren += `</${currentListType}>\n`;
            }
            
            // ìƒˆ ë¦¬ìŠ¤íŠ¸ ì‹œì‘
            const listClass = listType === 'ul' ? 'list-disc' : 'list-decimal';
            currentListType = listType;
            renderedChildren += `<${listType} class="${listClass} ml-6 my-4">\n`;
          }
          
          // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€
          renderedChildren += renderedContent;
        } else {
          // ë¦¬ìŠ¤íŠ¸ ì•„ë‹Œ ë¸”ë¡ì„ ë§Œë‚¬ì„ ë•Œ, ì§„í–‰ ì¤‘ì¸ ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë‹«ê¸°
          if (currentListType) {
            renderedChildren += `</${currentListType}>\n`;
            currentListType = null;
          }
          
          // ì¼ë°˜ ë¸”ë¡ ì¶”ê°€
          renderedChildren += renderedContent;
        }
      } else {
        notionLog.warn('íƒ€ì… ì •ë³´ê°€ ì—†ëŠ” ë¸”ë¡:', childBlock);
      }
    }
    
    // ë§ˆì§€ë§‰ì— ì—´ë¦° ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë‹«ê¸°
    if (currentListType) {
      renderedChildren += `</${currentListType}>\n`;
    }
    
    return renderedChildren;
  } catch (error) {
    notionLog.error(`ğŸ”´ ë¸”ë¡ì˜ ìì‹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${block.id}`, error);
    return '<p class="text-red-500">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
  }
}

/**
 * íŠ¹ì • IDë¡œ ê²Œì‹œë¬¼ ê°€ì ¸ì˜¤ê¸°
 */
export async function getPostById(id: string): Promise<BlogPost | null> {
  try {
    const page = await notion.pages.retrieve({ page_id: id }) as PageObjectResponse;
    const post = pageToPost(page);
    
    // ì»¨í…ì¸  ë° ì¸ë„¤ì¼ ê°€ì ¸ì˜¤ê¸°
    const { content, thumbnail } = await getPageContentAndThumbnail(id);
    post.content = content;
    
    // í˜ì´ì§€ ì†ì„±ì—ì„œ ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° ì»¨í…ì¸ ì—ì„œ ì¶”ì¶œí•œ ì¸ë„¤ì¼ ì‚¬ìš©
    if (!post.image && thumbnail) {
      post.image = thumbnail;
    }
    
    return post;
  } catch (error) {
    notionLog.error(`Error fetching post with ID ${id}:`, error);
    return null;
  }
}

/**
 * íŠ¹ì • ìŠ¬ëŸ¬ê·¸ë¡œ ê²Œì‹œë¬¼ ê°€ì ¸ì˜¤ê¸°
 */
export async function getPostBySlug(slug: string): Promise<BlogPost | null> {
  try {
    notionLog.info(`ğŸ“˜ ìºì‹œ ë ˆì´ì–´ë¥¼ í†µí•´ ìŠ¬ëŸ¬ê·¸ "${slug}"ë¡œ í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° ì‹œì‘...`);
    return await getCachedPostBySlug(slug) as BlogPost | null;
  } catch (error) {
    notionLog.error(`Error fetching post with slug ${slug} via cache layer:`, error);
    return null;
  }
}

// ê´€ë ¨ í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
export const getRelatedPosts = cache(async (currentPostId: string, categoryName: string): Promise<BlogPost[]> => {
  notionLog.info(`ğŸ“˜ ìºì‹œ ë ˆì´ì–´ë¥¼ í†µí•´ ì¹´í…Œê³ ë¦¬ "${categoryName}"ì˜ ê´€ë ¨ í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° ì‹œì‘...`);
  return await getCachedRelatedPosts(currentPostId, categoryName as CategoryId) as BlogPost[];
});

// ë…¸ì…˜ í˜ì´ì§€ì˜ ì „ì²´ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°
export async function getPageBlocks(pageId: string) {
  try {
    notionLog.info(`ğŸ“˜ í˜ì´ì§€ ${pageId}ì˜ ì „ì²´ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œì‘`);
    const startTime = Date.now();
    
    // ëª¨ë“  ë¸”ë¡ì„ ì¬ê·€ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    async function getAllPageBlocks(blockId: string, depth = 0): Promise<any[]> {
      const blocks: any[] = [];
      let cursor: string | undefined;
      let totalFetched = 0;
      let pageCount = 0;
      
      try {
        // ìµœëŒ€ 30ë²ˆì˜ í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ìµœëŒ€ 3000ê°œ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œë„
        for (let attempt = 0; attempt < 30; attempt++) {
          pageCount++;
          
          // API ìš”ì²­ ì‚¬ì´ì— ì§€ì—° ì¶”ê°€ (ì†ë„ ì œí•œ ë°©ì§€)
          if (attempt > 0) {
            await new Promise(resolve => setTimeout(resolve, 300));
          }
          
          const { results, next_cursor } = await notion.blocks.children.list({
            block_id: blockId,
            start_cursor: cursor,
            page_size: 100, // ìµœëŒ€ì¹˜ì¸ 100ê°œì”© ê°€ì ¸ì˜¤ê¸°
          });
          
          if (results.length > 0) {
            blocks.push(...results);
            totalFetched += results.length;
            
            // 100ê°œ ë‹¨ìœ„ë¡œë§Œ ë¡œê·¸ ì¶œë ¥í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ
            if (totalFetched % 100 === 0 || pageCount === 1) {
              notionLog.info(`ğŸ“˜ í˜ì´ì§€ ${blockId.substring(0, 8)}...ì—ì„œ ${totalFetched}ê°œ ë¸”ë¡ ì¶”ê°€ (ê¹Šì´: ${depth}, í˜ì´ì§€: ${pageCount})`);
            }
          }
          
          // ë‹¤ìŒ í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
          if (!next_cursor) break;
          cursor = next_cursor;
        }
        
        // í•˜ìœ„ ë¸”ë¡ì´ ìˆëŠ” ë¸”ë¡ë§Œ í•„í„°ë§
        const blocksWithChildren = blocks.filter(block => block.has_children);
        
        if (blocksWithChildren.length > 0) {
          notionLog.info(`ğŸ“˜ í•˜ìœ„ ë¸”ë¡ì´ ìˆëŠ” ë¸”ë¡ ${blocksWithChildren.length}ê°œ ë°œê²¬ (ê¹Šì´: ${depth})`);
        }
        
        // í•˜ìœ„ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°ë¥¼ ë³‘ë ¬ ì²˜ë¦¬í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ
        const childBlockPromises = blocksWithChildren.map(async (block) => {
          // API ìš”ì²­ ì‚¬ì´ì— ì§§ì€ ì§€ì—° ì¶”ê°€ (ì†ë„ ì œí•œ ë°©ì§€)
          await new Promise(resolve => setTimeout(resolve, 200));
          
          if (depth < 20) { // ê¹Šì´ ì œí•œ ì ìš©
            const childBlocks = await getAllPageBlocks(block.id, depth + 1);
            if (childBlocks.length > 0) {
              (block as any).children = childBlocks;
              notionLog.info(`ğŸ“˜ ë¸”ë¡ ${block.id.substring(0, 8)}...ì— ${childBlocks.length}ê°œ í•˜ìœ„ ë¸”ë¡ ì¶”ê°€ (ê¹Šì´: ${depth + 1})`);
            }
          } else {
            notionLog.warn(`ğŸ“™ ìµœëŒ€ ê¹Šì´ ì´ˆê³¼ë¡œ í•˜ìœ„ ë¸”ë¡ ìƒëµ: ${block.id.substring(0, 8)}...`);
          }
          return block;
        });
        
        // ëª¨ë“  í•˜ìœ„ ë¸”ë¡ ìš”ì²­ ì™„ë£Œ ëŒ€ê¸°
        await Promise.all(childBlockPromises);
        
        return blocks;
      } catch (error) {
        notionLog.error(`ğŸ”´ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜ (ID: ${blockId.substring(0, 8)}...):`, error);
        return blocks; // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì´ë¯¸ ê°€ì ¸ì˜¨ ë¸”ë¡ì€ ë°˜í™˜
      }
    }
    
    // ì‹¤ì œ ëª¨ë“  ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰
    const blocks = await getAllPageBlocks(pageId);
    const endTime = Date.now();
    const timeElapsed = (endTime - startTime) / 1000;
    
    notionLog.info(`ğŸ“˜ í˜ì´ì§€ ${pageId.substring(0, 8)}...ì˜ ëª¨ë“  ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ì´ ${blocks.length}ê°œ (ì†Œìš” ì‹œê°„: ${timeElapsed.toFixed(2)}ì´ˆ)`);
    
    // í•˜ìœ„ ë¸”ë¡ ìˆ˜ ê³„ì‚° (ë””ë²„ê¹…ìš©)
    let totalChildBlocks = 0;
    const countChildBlocks = (blocks: any[]) => {
      blocks.forEach(block => {
        if (block.children && block.children.length > 0) {
          totalChildBlocks += block.children.length;
          countChildBlocks(block.children);
        }
      });
    };
    
    countChildBlocks(blocks);
    notionLog.info(`ğŸ“˜ ì´ í•˜ìœ„ ë¸”ë¡ ìˆ˜: ${totalChildBlocks}ê°œ`);
    
    return blocks;
  } catch (error) {
    notionLog.error(`Error fetching page blocks: ${error}`);
    return [];
  }
}

// ë…¸ì…˜ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í˜ì´ì§€ë“¤ ê°€ì ¸ì˜¤ê¸°
export async function getDatabase() {
  const response = await notion.databases.query({
    database_id: databaseId as string,
    sorts: [
      {
        property: 'Created',
        direction: 'descending',
      },
    ],
  });
  
  return response.results;
}

// í˜ì´ì§€ IDë¡œ íŠ¹ì • í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
export async function getPage(pageId: string) {
  const response = await notion.pages.retrieve({ page_id: pageId });
  return response;
}

/**
 * ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë””ë²„ê¹…ìš©)
 */
export async function getDatabaseInfo() {
  try {
    if (!databaseId) {
      throw new Error("NOTION_DATABASE_ID í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }

    const database = await notion.databases.retrieve({
      database_id: databaseId as string,
    });
    
    // titleì´ ìˆëŠ” ê²½ìš°ì—ëŠ” íƒ€ì´í‹€ ì¶”ì¶œ, ì—†ìœ¼ë©´ IDë§Œ ë°˜í™˜
    const dbTitle = 'title' in database ? 
      database.title.map(textObj => textObj.plain_text).join('') : 
      'Untitled Database';
    
    return {
      id: database.id,
      title: dbTitle,
      propertiesCount: Object.keys(database.properties).length,
      properties: database.properties,
    };
  } catch (error) {
    notionLog.error("Error fetching database info:", error);
    return null;
  }
}

// ëª¨ë“  ê²Œì‹œë¬¼ ê°€ì ¸ì˜¤ê¸° (ìºì‹œ ë ˆì´ì–´ ì‚¬ìš©)
export async function getAllPosts(): Promise<BlogPost[]> {
  try {
    notionLog.info("ğŸ“˜ ìºì‹œ ë ˆì´ì–´ë¥¼ í†µí•´ ëª¨ë“  í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° ì‹œì‘...");
    return await getCachedPosts() as BlogPost[];
  } catch (error) {
    notionLog.error("Error fetching posts via cache layer:", error);
    // ì˜¤ë¥˜ ìƒì„¸ ì •ë³´ ë¡œê¹…
    if (error instanceof Error) {
      notionLog.error("Error details:", error.stack);
    }
    return []; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
  }
}

// HTML ë¬¸ìì—´ì„ ì •ë¦¬í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
function cleanHtml(html: string): string {
  // ì¼ë°˜ì ì¸ HTML íƒœê·¸ íŒ¨í„´ì„ ì •ë¦¬
  let cleaned = html;
  
  // íŠ¹ì • ë‹«ëŠ” íƒœê·¸ ì¡°í•©ì„ ì°¾ì•„ì„œ ì œê±°
  const patterns = [
    /<\/figure><\/div><\/li><\/ul>/g,
    /<\/figure><\/div>/g,
    /<\/div><\/div>/g,
    /<\/li><\/ul>/g,
    /<\/ul><\/li>/g,
    /<\/div><\/li>/g,
    /<\/li><\/div>/g,
    /<\/div>(?!\s*<)/g,  // div íƒœê·¸ê°€ ì‹¤ì œ íƒœê·¸ê°€ ì•„ë‹Œ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œëœ ê²½ìš° ì œê±°
    /(?<=<\/figure>)\s*<\/div>/g,  // figure íƒœê·¸ ë’¤ì— ì˜¤ëŠ” ë¶ˆí•„ìš”í•œ ë‹«ëŠ” div íƒœê·¸
    /&lt;\/div&gt;/g,  // HTML ì´ìŠ¤ì¼€ì´í”„ëœ </div> íƒœê·¸ ì œê±°
    /<p>\s*&lt;\/div&gt;\s*<\/p>/g  // <p></div></p> í˜•íƒœì˜ íƒœê·¸ ì œê±°
  ];
  
  patterns.forEach(pattern => {
    // ì‹¤ì œ HTML íƒœê·¸ê°€ ì•„ë‹Œ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œëœ íƒœê·¸ë§Œ ì œê±°
    cleaned = cleaned.replace(pattern, '');
  });
  
  // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ë’¤ì— ì˜¤ëŠ” ë‹¨ë… ë‹«ëŠ” div íƒœê·¸ ì œê±°
  cleaned = cleaned.replace(/<div class="my-8 image-container">([\s\S]*?)<\/div>\s*<\/div>/g, '<div class="my-8 image-container">$1</div>');
  
  // figure íƒœê·¸ ë’¤ì˜ ëª¨ë“  ë¶ˆí•„ìš”í•œ ë‹«ëŠ” div íƒœê·¸ ì œê±° (ë” ê°•ë ¥í•œ ë²„ì „)
  cleaned = cleaned.replace(/<figure class="my-8">([\s\S]*?)<\/figure>\s*(<\/div>)+/g, '<figure class="my-8">$1</figure>');
  
  // í…ìŠ¤íŠ¸ë¡œ í‘œì‹œëœ </div> íƒœê·¸ë¥¼ ì§ì ‘ ì œê±°
  cleaned = cleaned.replace(/&lt;\/div&gt;/g, '');
  cleaned = cleaned.replace(/&amp;lt;\/div&amp;gt;/g, '');
  
  // ë¹ˆ p íƒœê·¸ ì•ˆì˜ </div> í…ìŠ¤íŠ¸ ì œê±°
  cleaned = cleaned.replace(/<p>\s*<\/div>\s*<\/p>/g, '');
  
  return cleaned;
}

// ë¸”ë¡ ì²˜ë¦¬ë¥¼ ìœ„í•œ í•¨ìˆ˜
async function processBlocks(blocks: BlockObjectResponse[]): Promise<string> {
  let html = '';
  const imageUrls: string[] = [];
  
  try {
    notionLog.info(`ğŸ“˜ processBlocks: ${blocks.length}ê°œ ë¸”ë¡ ì²˜ë¦¬ ì‹œì‘`);
    
    // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ê·¸ë£¹í™”ë¥¼ ìœ„í•œ ë³€ìˆ˜
    let currentListType: string | null = null;
    let inList = false;
    
    for (let i = 0; i < blocks.length; i++) {
      const block = blocks[i];
      
      if (!block) {
        notionLog.warn('âš ï¸ Null ë˜ëŠ” undefined ë¸”ë¡ ë°œê²¬, ê±´ë„ˆëœë‹ˆë‹¤.');
        continue;
      }
      
      try {
        notionLog.info(`ğŸ“˜ ë¸”ë¡ ì²˜ë¦¬ ì¤‘ (#${i+1}/${blocks.length}): íƒ€ì…=${block.type}, ID=${block.id.substring(0, 8)}...`);
        
        const blockType = block.type;
        const isListItem = ['bulleted_list_item', 'numbered_list_item'].includes(blockType);
        
        // ë¦¬ìŠ¤íŠ¸ ì‹œì‘ ë˜ëŠ” ì¢…ë£Œ ì²˜ë¦¬
        if (isListItem) {
          const listType = blockType === 'bulleted_list_item' ? 'ul' : 'ol';
          
          // ìƒˆ ë¦¬ìŠ¤íŠ¸ ì‹œì‘
          if (!inList || currentListType !== listType) {
            // ì´ì „ ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë‹«ìŒ
            if (inList) {
              html += `</${currentListType}>\n`;
            }
            
            // ìƒˆ ë¦¬ìŠ¤íŠ¸ ì‹œì‘
            const listClass = listType === 'ul' ? 'list-disc' : 'list-decimal';
            html += `<${listType} class="${listClass} ml-6 my-4">\n`;
            currentListType = listType;
            inList = true;
          }
        } else if (inList) {
          // ë¦¬ìŠ¤íŠ¸ ì¢…ë£Œ
          html += `</${currentListType}>\n`;
          inList = false;
          currentListType = null;
        }
        
        // ë¸”ë¡ ë Œë”ë§ ë° ì´ë¯¸ì§€ URL ìˆ˜ì§‘
        const result = await renderBlock(block as BlockObjectResponse);
        let renderedContent = result.renderedHtml;
        
        // íŠ¹ë³„í•œ ë¸”ë¡ íƒ€ì…ì— ë”°ë¥¸ ì¶”ê°€ ì²˜ë¦¬
        if (blockType === 'image') {
          // ì´ë¯¸ì§€ ë¸”ë¡ì´ ë¦¬ìŠ¤íŠ¸ ë‚´ë¶€ì— ìˆìœ¼ë©´ íŠ¹ë³„ ì²˜ë¦¬
          if (inList) {
            // í˜„ì¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹«ê³ 
            html += `</${currentListType}>\n`;
            // ì´ë¯¸ì§€ ì¶”ê°€
            html += renderedContent;
            // ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ì‹œì‘
            const listClass = currentListType === 'ul' ? 'list-disc' : 'list-decimal';
            html += `<${currentListType} class="${listClass} ml-6 my-4">\n`;
          } else {
            html += renderedContent;
          }
        } else {
          // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ HTML ì¶”ê°€
          if (!isListItem || !inList) {
            html += renderedContent;
          } else {
            // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì¸ ê²½ìš°ëŠ” ë¦¬ìŠ¤íŠ¸ ë‚´ë¶€ì— ì¶”ê°€
            html += renderedContent;
          }
        }
        
        if (result.imageUrl) {
          imageUrls.push(result.imageUrl);
        }
        
        // ë¸”ë¡ì— í•˜ìœ„ ë¸”ë¡ì´ ìˆëŠ” ê²½ìš° ì¬ê·€ì ìœ¼ë¡œ ì²˜ë¦¬
        if ((block as any).children && (block as any).children.length > 0) {
          notionLog.info(`ğŸ“˜ í•˜ìœ„ ë¸”ë¡ ì²˜ë¦¬ ì‹œì‘: ${(block as any).children.length}ê°œ (ë¶€ëª¨: ${block.type})`);
          
          // í…Œì´ë¸”ê³¼ í† ê¸€ì€ ì´ë¯¸ renderBlock ë‚´ë¶€ì—ì„œ ìì‹ ì²˜ë¦¬ë¥¼ í•˜ë¯€ë¡œ ì œì™¸
          if (!['table', 'toggle', 'callout'].includes(block.type)) {
            const childrenHtml = await processBlocks((block as any).children);
            
            if (childrenHtml.trim()) {
              // íŠ¹ì • ë¸”ë¡ íƒ€ì…ì— ë”°ë¼ í•˜ìœ„ ë¸”ë¡ì„ ì ì ˆíˆ í¬ë§·íŒ…
              if (isListItem) {
                // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë‚´ë¶€ì— í•˜ìœ„ ì½˜í…ì¸  ì¶”ê°€
                // li íƒœê·¸ë¥¼ ë‹«ê¸° ì „ì— ì¤‘ì²© ì½˜í…ì¸  ì‚½ì…
                const liCloseTagIndex = html.lastIndexOf('</li>');
                if (liCloseTagIndex !== -1) {
                  html = html.substring(0, liCloseTagIndex) + 
                         childrenHtml + 
                         html.substring(liCloseTagIndex);
                } else {
                  notionLog.warn(`âš ï¸ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì—ì„œ </li> íƒœê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìì‹ ì½˜í…ì¸ ë¥¼ ì¶”ê°€í•  ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                  html += childrenHtml;
                }
              } else {
                // ë‹¤ë¥¸ íƒ€ì…ì˜ ë¸”ë¡ì€ ê·¸ëƒ¥ ë’¤ì— ì¶”ê°€
                html += childrenHtml;
              }
            }
          } else {
            notionLog.info(`ğŸ“˜ ${block.type} ë¸”ë¡ì˜ í•˜ìœ„ ë¸”ë¡ì€ ì´ë¯¸ renderBlockì—ì„œ ì²˜ë¦¬ë¨`);
          }
        }
      } catch (blockError) {
        notionLog.error(`ğŸ”´ ë¸”ë¡ ì²˜ë¦¬ ì˜¤ë¥˜: ${block.id}`, blockError);
        html += `<p class="text-red-500">ë¸”ë¡ ë¡œë”© ì˜¤ë¥˜: ${block.id}</p>`;
      }
    }
    
    // ì²˜ë¦¬ê°€ ëë‚¬ì„ ë•Œ ì—´ë ¤ìˆëŠ” ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë‹«ê¸°
    if (inList && currentListType) {
      html += `</${currentListType}>\n`;
    }
    
    notionLog.info(`ğŸ“˜ processBlocks ì™„ë£Œ: ì´ ${blocks.length}ê°œ ë¸”ë¡ ì²˜ë¦¬ë¨, HTML ê¸¸ì´: ${html.length}`);
    
    // HTML ì •ë¦¬ ì‘ì—… ìˆ˜í–‰
    const cleanedHtml = cleanHtml(html);
    notionLog.info(`ğŸ“˜ HTML ì •ë¦¬ ì™„ë£Œ: ì •ë¦¬ ì „ ${html.length} ê¸€ì â†’ ì •ë¦¬ í›„ ${cleanedHtml.length} ê¸€ì`);
    
    return cleanedHtml;
  } catch (error) {
    notionLog.error('ğŸ”´ processBlocks ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    return `<div class="notion-error">ë¸”ë¡ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div>`;
  }
}

// ë‹¨ì¼ ë¸”ë¡ ë Œë”ë§ ë° ì´ë¯¸ì§€ URL ì¶”ì¶œ
async function renderBlock(block: BlockObjectResponse): Promise<{ renderedHtml: string, imageUrl: string | null }> {
  if (!block) {
    notionLog.warn('Null or undefined block passed to renderBlock');
    return { renderedHtml: '', imageUrl: null };
  }
  
  try {
    let renderedHtml = '';
    let imageUrl: string | null = null;
    
    // ë””ë²„ê¹…: ì²˜ë¦¬ ì¤‘ì¸ ë¸”ë¡ íƒ€ì… ë¡œê·¸
    notionLog.debug(`ë¸”ë¡ íƒ€ì… ì²˜ë¦¬: ${block.type}, ID: ${block.id.substring(0, 8)}...`);
    
    // ì¤‘ì²©ëœ ë¸”ë¡ í™•ì¸
    if ('has_children' in block && block.has_children) {
      notionLog.debug(`ğŸ“˜ ì¤‘ì²©ëœ í•˜ìœ„ ë¸”ë¡ ìˆìŒ: ${block.id.substring(0, 8)}... (íƒ€ì…: ${block.type})`);
    }
    
    // ë¸”ë¡ì˜ ê³µí†µ ìƒ‰ìƒ ì •ë³´ ì¶”ì¶œ
    const blockColor = (block as any)[block.type]?.color || 'default';
    let colorStyle = '';
    
    // ë¸”ë¡ ìƒ‰ìƒ ì²˜ë¦¬ ê°œì„ 
    if (blockColor && blockColor !== 'default') {
      const colorMap: Record<string, string> = {
        "blue": "#2196f3",
        "blue_background": "#e3f2fd",
        "brown": "#795548",
        "brown_background": "#efebe9",
        "gray": "#9e9e9e",
        "gray_background": "#f5f5f5",
        "green": "#4caf50",
        "green_background": "#e8f5e9",
        "orange": "#ff9800",
        "orange_background": "#fff3e0",
        "pink": "#e91e63",
        "pink_background": "#fce4ec",
        "purple": "#9c27b0",
        "purple_background": "#f3e5f5",
        "red": "#f44336",
        "red_background": "#ffebee",
        "yellow": "#ffeb3b",
        "yellow_background": "#fffde7",
        "black": "#000000",
        "white": "#ffffff",
      };
      
      if (blockColor.endsWith('_background')) {
        const bgColor = colorMap[blockColor] || blockColor;
        colorStyle = `background-color: ${bgColor}; padding: 0.5rem;`;
      } else {
        const textColor = colorMap[blockColor] || blockColor;
        colorStyle = `color: ${textColor};`;
      }
    }
    
    switch (block.type) {
      case 'paragraph':
        const paragraphContent = renderRichText(block.paragraph.rich_text);
        // pre-wrap ìŠ¤íƒ€ì¼ì„ ì¶”ê°€í•˜ì—¬ ê³µë°± ë° ì¤„ë°”ê¿ˆ ë³´ì¡´
        renderedHtml = `<p class="my-4 leading-relaxed text-gray-800 whitespace-pre-wrap" style="${colorStyle}">${paragraphContent || '<br>'}</p>`;
        break;
        
      case 'heading_1':
        const h1Content = renderRichText(block.heading_1.rich_text);
        renderedHtml = `<h1 class="text-3xl font-bold mt-8 mb-4 text-gray-900" style="${colorStyle}">${h1Content}</h1>`;
        break;
        
      case 'heading_2':
        const h2Content = renderRichText(block.heading_2.rich_text);
        renderedHtml = `<h2 class="text-2xl font-semibold mt-6 mb-3 text-gray-900" style="${colorStyle}">${h2Content}</h2>`;
        break;
        
      case 'heading_3':
        const h3Content = renderRichText(block.heading_3.rich_text);
        renderedHtml = `<h3 class="text-xl font-semibold mt-5 mb-2 text-gray-900" style="${colorStyle}">${h3Content}</h3>`;
        break;
        
      case 'bulleted_list_item':
        const bulletContent = renderRichText(block.bulleted_list_item.rich_text);
        renderedHtml = `<li class="ml-6 my-1.5 text-gray-800 whitespace-pre-wrap" style="${colorStyle}">${bulletContent}</li>`;
        break;
        
      case 'numbered_list_item':
        const numberedContent = renderRichText(block.numbered_list_item.rich_text);
        renderedHtml = `<li class="ml-6 my-1.5 text-gray-800 whitespace-pre-wrap" style="${colorStyle}">${numberedContent}</li>`;
        break;
        
      case 'quote':
        const quoteContent = renderRichText(block.quote.rich_text);
        renderedHtml = `<blockquote class="pl-4 border-l-4 border-gray-300 italic my-4 text-gray-700 whitespace-pre-wrap" style="${colorStyle}">${quoteContent}</blockquote>`;
        break;
        
      case 'code':
        // ì½”ë“œ ë¸”ë¡ ë‚´ìš© ì²˜ë¦¬ ê°œì„ 
        const codeTexts: string[] = [];
        
        // ì›ë³¸ í…ìŠ¤íŠ¸ ë¡œê·¸
        if (block.code.rich_text.length > 0) {
          notionLog.debug(`ì½”ë“œ ë¸”ë¡ ì²˜ë¦¬: ê¸¸ì´ ${block.code.rich_text.length}, ì–¸ì–´: ${block.code.language || 'plaintext'}`);
        }
        
        for (const richText of block.code.rich_text) {
          let codeText = richText.plain_text || "";
          
          // ê³µë°±ê³¼ ë“¤ì—¬ì“°ê¸° ë³´ì¡´ì„ ìœ„í•œ ì²˜ë¦¬
          if (codeText) {
            // HTML ì´ìŠ¤ì¼€ì´í”„ ì ìš©
            codeText = codeText
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
            
            // íƒ­ì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜ (HTMLì—ì„œ íƒ­ ê°„ê²©ì´ ì¼ì •í•˜ì§€ ì•Šê¸° ë•Œë¬¸)
            codeText = codeText.replace(/\t/g, "    ");
            
            codeTexts.push(codeText);
          }
        }
        
        const codeContent = codeTexts.join('');
        const language = block.code.language || 'plaintext';
        
        // ì½”ë“œ ë¸”ë¡ì—ì„œ white-space: pre ìŠ¤íƒ€ì¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ê³µë°±ê³¼ ì¤„ë°”ê¿ˆ ë³´ì¡´
        renderedHtml = `<pre class="bg-gray-50 rounded-md p-4 my-4 overflow-x-auto whitespace-pre"><code class="language-${language} text-sm">${codeContent}</code></pre>`;
        break;
        
      case 'callout':
        const calloutContent = renderRichText(block.callout.rich_text);
        const emoji = block.callout.icon?.type === 'emoji' ? block.callout.icon.emoji : '';
        renderedHtml = `<div class="bg-gray-50 rounded-md p-4 my-4 flex">
          <div class="mr-3 text-xl">${emoji}</div>
          <div class="whitespace-pre-wrap">${calloutContent}</div>
        </div>`;
        break;
        
      case 'toggle':
        const toggleContent = renderRichText(block.toggle.rich_text);
        const childrenResults = await renderChildren(block);
        renderedHtml = `<details class="my-4">
          <summary class="cursor-pointer font-medium">${toggleContent}</summary>
          <div class="mt-2 text-gray-700 whitespace-pre-wrap">
            ${childrenResults}
          </div>
        </details>`;
        break;
        
      case 'image':
        // ì´ë¯¸ì§€ URL êµ¬ì„±
        if (block.image.type === 'external') {
          imageUrl = block.image.external.url;
        } else if (block.image.type === 'file') {
          imageUrl = block.image.file.url;
        }
        
        // ì „ìš© ì´ë¯¸ì§€ ë Œë”ë§ í•¨ìˆ˜ ì‚¬ìš©
        renderedHtml = renderImage(block);
        break;
        
      case 'divider':
        renderedHtml = `<hr class="my-6 border-gray-200" />`;
        break;
        
      case 'table':
        // í…Œì´ë¸” ì²˜ë¦¬ ì¶”ê°€
        if ('table' in block && block.table) {
          notionLog.debug(`í…Œì´ë¸” ì²˜ë¦¬: ë„ˆë¹„ ${block.table.table_width || 'ì •ë³´ ì—†ìŒ'}`);
          
          // í…Œì´ë¸” ì²˜ë¦¬ë¥¼ ìœ„í•œ ìì‹ ë¸”ë¡ ê°€ì ¸ì˜¤ê¸° (rows)
          const tableRows = await renderChildren(block);
          
          // í…Œì´ë¸” ë Œë”ë§
          renderedHtml = `<div class="my-6 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
              ${tableRows}
            </table>
          </div>`;
        }
        break;
        
      case 'table_row':
        // í…Œì´ë¸” í–‰ ì²˜ë¦¬
        if ('table_row' in block && block.table_row) {
          const cells = block.table_row.cells || [];
          const rowHtml = cells.map(cell => {
            const cellContent = cell.map((text: any) => renderRichText(text)).join('');
            return `<td class="px-4 py-2 border border-gray-200">${cellContent || '&nbsp;'}</td>`;
          }).join('');
          
          renderedHtml = `<tr>${rowHtml}</tr>`;
        }
        break;
        
      default:
        notionLog.warn(`âš ï¸ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡ íƒ€ì…: ${block.type}`, block);
        renderedHtml = `<div class="text-gray-400">ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡ íƒ€ì…: ${block.type}</div>`;
    }
    
    return { renderedHtml, imageUrl };
  } catch (error) {
    notionLog.error(`ğŸ”´ ë¸”ë¡ ë Œë”ë§ ì˜¤ë¥˜: ${block.id}`, error);
    return { 
      renderedHtml: `<div class="text-red-500">ì˜¤ë¥˜: ë¸”ë¡ì„ ë Œë”ë§í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ${block.id}</div>`,
      imageUrl: null
    };
  }
}

// ì´ë¯¸ì§€ ë¸”ë¡ ë Œë”ë§ í•¨ìˆ˜
function renderImage(block: any): string {
  if (!block.image) return '';
  
  const imageUrl = block.image.file?.url || block.image.external?.url || '';
  const caption = block.image.caption?.length > 0 
    ? block.image.caption.map((text: any) => text.plain_text).join('') 
    : '';
  
  return `
    <figure class="my-8">
      <img 
        src="${imageUrl}" 
        alt="${caption || 'Image'}" 
        class="w-full rounded-lg"
      />
      ${caption ? `<figcaption class="text-center text-sm text-gray-500 mt-2">${caption}</figcaption>` : ''}
    </figure>
  `;
}

// ì¡°íšŒìˆ˜ ì¦ê°€ í•¨ìˆ˜
export async function increment(slug: string): Promise<number> {
  try {
    notionLog.info(`[Notion] Incrementing view count for slug: ${slug}`)
    
    // Find the page with the given slug
    const response = await notion.databases.query({
      database_id: databaseId as string,
      filter: {
        property: "Slug",
        rich_text: {
          equals: slug,
        },
      },
    })

    if (!response.results.length) {
      notionLog.error(`[Notion] No page found with slug: ${slug}`)
      return 0
    }

    // ì²« ë²ˆì§¸ ê²°ê³¼ ì‚¬ìš©
    const page = response.results[0] as PageObjectResponse;
    
    // Get the current view count
    const viewsProperty = page.properties.Views || page.properties.views;
    
    if (!viewsProperty || viewsProperty.type !== 'number') {
      notionLog.error(`[Notion] No valid view count found for ${slug}`)
      return 0
    }
    
    const oldViews = viewsProperty.number || 0
    const newViews = oldViews + 1

    // Update the view count
    await notion.pages.update({
      page_id: page.id,
      properties: {
        Views: {
          number: newViews
        }
      }
    })

    notionLog.info(`[Notion] Successfully updated view count for ${slug} to ${newViews}`)
    return newViews
  } catch (error) {
    notionLog.error('[Notion] Error incrementing view count:', error)
    return 0
  }
} 